var SS = SpreadsheetApp.getActiveSpreadsheet();
var SHEET_NAME_USERS = "Users";
var SHEET_NAME_RECORDS = "Records";
var SHEET_NAME_ACTIVITIES = "Activity_List";
var SHEET_NAME_CONFIG = "Config";

var SYSTEM_PASSWORD = "1234"; 

function initialSetup() {
  var sheetUsers = SS.getSheetByName(SHEET_NAME_USERS);
  if (!sheetUsers) { sheetUsers = SS.insertSheet(SHEET_NAME_USERS); sheetUsers.getRange("A1:F1").setValues([["ID", "Name", "Role", "Gender", "Dept", "Disability"]]); sheetUsers.setFrozenRows(1); }
  var sheetRecords = SS.getSheetByName(SHEET_NAME_RECORDS);
  if (!sheetRecords) { sheetRecords = SS.insertSheet(SHEET_NAME_RECORDS); var headers = ["活動名稱", "活動日期", "活動類別", "學年度", "學期", "ID", "姓名", "身分", "性別", "科系/單位", "特教類別", "寫入時間"]; sheetRecords.getRange("A1:L1").setValues([headers]); sheetRecords.setFrozenRows(1); }
  var sheetActs = SS.getSheetByName(SHEET_NAME_ACTIVITIES);
  if (!sheetActs) { sheetActs = SS.insertSheet(SHEET_NAME_ACTIVITIES); sheetActs.getRange("A1:G1").setValues([["日期(起)", "活動名稱", "活動類別", "活動方式", "具體成效", "日期(迄)", "建立時間"]]); sheetActs.setFrozenRows(1); }
  var sheetConfig = SS.getSheetByName(SHEET_NAME_CONFIG);
  if (!sheetConfig) { sheetConfig = SS.insertSheet(SHEET_NAME_CONFIG); sheetConfig.getRange("A1:B1").setValues([["活動類別選項", "特教障別選項"]]); var defaultCats = [["課業"],["職涯"],["人際"],["特教知能"],["特教宣導"],["ISP"],["ITP"],["特推會"]]; var defaultDis = [["自閉症"],["學習障礙"],["情緒行為障礙"],["腦性麻痺"],["肢體障礙"],["聽覺障礙"],["視覺障礙"],["智能障礙"],["身體病弱"],["多重障礙"],["其他障礙"]]; sheetConfig.getRange(2, 1, defaultCats.length, 1).setValues(defaultCats); sheetConfig.getRange(2, 2, defaultDis.length, 1).setValues(defaultDis); sheetConfig.setFrozenRows(1); }
}

function doGet(e) { return ContentService.createTextOutput("API V4.1 (Strict Logic) Online"); }

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    if (data.action === "login") { if (data.password === SYSTEM_PASSWORD) return outputJSON({status: "success"}); else return outputJSON({status: "error", message: "密碼錯誤"}); }
    if (data.action === "getSystemData") return getSystemData();
    if (data.action === "saveData") return saveData(data);
    if (data.action === "getStats") return getStats(data.userList);
    if (data.action === "importUsers") return importUsers(data.users);
    if (data.action === "searchUsers") return searchUsers(data.keyword);
    if (data.action === "getActivities") return getActivities();
    if (data.action === "batchCreateActivities") return batchCreateActivities(data.activities);
    if (data.action === "updateActivity") return updateActivity(data);
    if (data.action === "deleteActivity") return deleteActivity(data);
    if (data.action === "getReportData") return getReportData(data.filter); 
    if (data.action === "getMatrixData") return getMatrixData(data.filter);
    return outputJSON({status: "error", message: "Unknown Action"});
  } catch (err) { return outputJSON({status: "error", message: err.toString()}); }
}

// === 報表 A: 校務基本資料庫 (邏輯重寫) ===
function getReportData(filter) {
  var sheetRec = SS.getSheetByName(SHEET_NAME_RECORDS);
  var sheetAct = SS.getSheetByName(SHEET_NAME_ACTIVITIES);
  
  var actMetaMap = {};
  if (sheetAct.getLastRow() > 1) {
    var actData = sheetAct.getRange(2, 1, sheetAct.getLastRow()-1, 6).getValues();
    actData.forEach(function(row) {
      var d = Utilities.formatDate(new Date(row[0]), Session.getScriptTimeZone(), "yyyy-MM-dd");
      var key = d + "_" + row[1];
      var endDate = row[5] ? Utilities.formatDate(new Date(row[5]), Session.getScriptTimeZone(), "yyyy-MM-dd") : d;
      actMetaMap[key] = { method: row[3] || "", outcome: row[4] || "", endDate: endDate };
    });
  }

  if (sheetRec.getLastRow() <= 1) return outputJSON({status: "success", report: []});
  var data = sheetRec.getRange(2, 1, sheetRec.getLastRow() - 1, 12).getValues();
  var reportMap = {};
  
  data.forEach(function(row) {
    if (!isMatchFilter(row, filter)) return;
    var actName = row[0];
    var actDate = Utilities.formatDate(new Date(row[1]), Session.getScriptTimeZone(), "yyyy-MM-dd");
    var key = actDate + "_" + actName;
    
    if (!reportMap[key]) {
      var meta = actMetaMap[key] || { method: "", outcome: "", endDate: actDate };
      reportMap[key] = {
        name: actName, date: actDate, endDate: meta.endDate, category: row[2],
        acadYear: row[3], semester: row[4], method: meta.method, outcome: meta.outcome,
        teacherM: 0, teacherF: 0, studentM: 0, studentF: 0, otherM: 0, otherF: 0, spedCount: 0
      };
    }
    
    var role = (row[7] || "").toString().trim();
    var gender = (row[8] || "").toString().trim();
    var disability = (row[10] || "").toString().trim();
    var isMale = (gender === "男");
    
    // === [關鍵修改] 依照使用者指定的邏輯分類 ===
    
    // 1. 專任教師：教師
    if (role === "教師") {
      if(isMale) reportMap[key].teacherM++; else reportMap[key].teacherF++;
    } 
    // 2. 學生：特教生、工讀生、職員
    // (注意：前端會把"輔導人員"轉為"職員")
    else if (role === "特教生" || role === "工讀生" || role === "職員") {
      if(isMale) reportMap[key].studentM++; else reportMap[key].studentF++;
    } 
    // 3. 其他：家長、校外人士
    else if (role === "家長" || role === "校外人士") {
      if(isMale) reportMap[key].otherM++; else reportMap[key].otherF++;
    }
    // 例外處理：若有未定義身分，暫歸類為其他 (避免數據遺失)
    else {
      if(isMale) reportMap[key].otherM++; else reportMap[key].otherF++;
    }
    
    // 特教生人次 (獨立計算：只要身分是特教生，或有填障別)
    if (role === "特教生" || (disability && disability !== "無")) {
      reportMap[key].spedCount++;
    }
  });
  
  var reportList = Object.values(reportMap);
  reportList.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
  return outputJSON({status: "success", report: reportList});
}

// === 其他函式 (維持不變) ===
function getMatrixData(filter) {
  var sheetRec = SS.getSheetByName(SHEET_NAME_RECORDS); if (sheetRec.getLastRow() <= 1) return outputJSON({status: "success", activities: [], stats: {}});
  var allRecords = sheetRec.getRange(2, 1, sheetRec.getLastRow() - 1, 12).getValues(); var activitySet = {}; var disabilityStats = {}; 
  allRecords.forEach(function(row) {
    if (!isMatchFilter(row, filter)) return;
    var actDate = Utilities.formatDate(new Date(row[1]), Session.getScriptTimeZone(), "yyyy-MM-dd"); var actName = row[0]; var actCat = row[2]; var key = actDate + "_" + actName;
    if (!activitySet[key]) { activitySet[key] = { key: key, name: actName, date: actDate, category: actCat }; disabilityStats[key] = { total: 0, details: {} }; }
    var userDisability = (row[10] || "").toString().trim(); disabilityStats[key].total++;
    if (userDisability && userDisability !== "無") { if (!disabilityStats[key].details[userDisability]) disabilityStats[key].details[userDisability] = 0; disabilityStats[key].details[userDisability]++; }
  });
  var activities = Object.values(activitySet).sort(function(a, b) { return new Date(a.date) - new Date(b.date); }); return outputJSON({ status: "success", activities: activities, stats: disabilityStats });
}
function isMatchFilter(row, filter) { if (!filter || !filter.year || filter.year === 'all') return true; var actDate = new Date(row[1]); var rAcadYear = row[3]; var rSemester = row[4]; if (filter.mode === 'calendar') { return actDate.getFullYear().toString() === filter.year.toString(); } else { if (rAcadYear.toString() !== filter.year.toString()) return false; if (filter.semester && filter.semester !== 'all') return rSemester.toString() === filter.semester.toString(); return true; } }
function getSystemData() { var sheetUsers = SS.getSheetByName(SHEET_NAME_USERS); var usersData = []; if (sheetUsers.getLastRow() > 1) { var raw = sheetUsers.getRange(2, 1, sheetUsers.getLastRow() - 1, 6).getValues(); usersData = raw.map(function(r) { return { id: r[0].toString(), name: r[1].toString(), role: r[2], gender: r[3], dept: r[4], disability: r[5] }; }); } var sheetConfig = SS.getSheetByName(SHEET_NAME_CONFIG); var categories = [], disabilities = []; if (sheetConfig && sheetConfig.getLastRow() > 1) { var confRaw = sheetConfig.getRange(2, 1, sheetConfig.getLastRow() - 1, 2).getValues(); confRaw.forEach(function(r) { if(r[0]) categories.push(r[0].toString()); if(r[1]) disabilities.push(r[1].toString()); }); } if(categories.length===0) categories = ["課業","職涯","人際","特教知能","特教宣導","ISP","ITP"]; if(disabilities.length===0) disabilities = ["自閉症","學習障礙","情緒行為障礙","腦性麻痺","肢體障礙","聽覺障礙","視覺障礙","智能障礙","身體病弱","多重障礙","其他障礙"]; return outputJSON({ status: "success", users: usersData, config: { categories: categories, disabilities: disabilities } }); }
function getUsersMap() { var sheet = SS.getSheetByName(SHEET_NAME_USERS); var data = sheet.getDataRange().getValues(); var map = {}; for (var i = 1; i < data.length; i++) { var row = data[i]; var u = { id: row[0].toString(), name: row[1].toString(), role: row[2], gender: row[3], dept: row[4], disability: row[5] }; if (u.id) map[u.id] = u; if (u.name) map[u.name] = u; } return map; }
function saveData(data) { var sheet = SS.getSheetByName(SHEET_NAME_RECORDS); var timestamp = new Date(); var actDate = new Date(data.activityDate); var year = actDate.getFullYear(); var month = actDate.getMonth() + 1; var academicYear = (month >= 8) ? (year - 1911) : (year - 1912); var semester = (month >= 8 || month === 1) ? 1 : 2; var userMap = getUsersMap(); var newRows = data.userIds.map(function(key) { var u = userMap[key] || { name: key, role: "未建檔", gender:"", dept:"", disability:"" }; return [data.activityName, data.activityDate, data.activityCategory || "未分類", academicYear, semester, u.id || key, u.name, u.role, u.gender, u.dept, u.disability, timestamp]; }); if (newRows.length > 0) sheet.getRange(sheet.getLastRow() + 1, 1, newRows.length, 12).setValues(newRows); return outputJSON({status: "success", count: newRows.length}); }
function getStats(inputList) { var userMap = getUsersMap(); var foundUsers = [], notFound = [], processedIds = {}; inputList.forEach(function(key) { var k = key.toString().trim(); if (!k) return; var u = userMap[k]; if (u) { var uniqueKey = u.id || u.name; if (!processedIds[uniqueKey]) { foundUsers.push(u); processedIds[uniqueKey] = true; } } else { notFound.push(k); } }); var stats = { total: foundUsers.length, roles: {} }; foundUsers.forEach(function(u) { stats.roles[u.role] = (stats.roles[u.role] || 0) + 1; }); return outputJSON({ status: "success", details: foundUsers, stats: stats, notFound: notFound }); }
function importUsers(users) { var sheet = SS.getSheetByName(SHEET_NAME_USERS); var data = sheet.getDataRange().getValues(); var existingMap = {}; for (var i = 1; i < data.length; i++) { var id = data[i][0].toString(); if(id) existingMap[id] = i; } var rowsToAppend = []; var isModified = false; users.forEach(function(u) { var id = u.id.toString(); var rowArr = [id, u.name, u.role, u.gender, u.dept, u.disability]; if (id && existingMap.hasOwnProperty(id)) { data[existingMap[id]] = rowArr; isModified = true; } else { rowsToAppend.push(rowArr); } }); if (isModified && data.length > 1) sheet.getRange(2, 1, data.length - 1, 6).setValues(data.slice(1)); if (rowsToAppend.length > 0) sheet.getRange(sheet.getLastRow() + 1, 1, rowsToAppend.length, 6).setValues(rowsToAppend); return outputJSON({status: "success", count: users.length}); }
function getActivities() { var sheet = SS.getSheetByName(SHEET_NAME_ACTIVITIES); if (sheet.getLastRow() <= 1) return outputJSON({status: "success", activities: []}); var lastRow = sheet.getLastRow(); var limit = 300; var startRow = Math.max(2, lastRow - limit + 1); var numRows = lastRow - startRow + 1; var data = sheet.getRange(startRow, 1, numRows, 6).getValues(); var activities = data.map(function(row) { var d = new Date(row[0]); var dateStr = Utilities.formatDate(d, Session.getScriptTimeZone(), "yyyy-MM-dd"); var ed = row[5] ? new Date(row[5]) : d; var endDateStr = Utilities.formatDate(ed, Session.getScriptTimeZone(), "yyyy-MM-dd"); return { date: dateStr, endDate: endDateStr, name: row[1], category: row[2], method: row[3] || "", outcome: row[4] || "" }; }); return outputJSON({status: "success", activities: activities.reverse()}); }
function batchCreateActivities(acts) { var sheet = SS.getSheetByName(SHEET_NAME_ACTIVITIES); var timestamp = new Date(); var rows = acts.map(function(a) { return [a.date, a.name, a.category, a.method || "", a.outcome || "", a.endDate || a.date, timestamp]; }); if (rows.length > 0) sheet.getRange(sheet.getLastRow() + 1, 1, rows.length, 7).setValues(rows); return outputJSON({status: "success", count: rows.length}); }
function updateActivity(data) { var sheet = SS.getSheetByName(SHEET_NAME_ACTIVITIES); var rows = sheet.getDataRange().getValues(); for (var i = 1; i < rows.length; i++) { var rowDate = Utilities.formatDate(new Date(rows[i][0]), Session.getScriptTimeZone(), "yyyy-MM-dd"); if (rows[i][1] === data.originalName && rowDate === data.originalDate) { var d = data.newData; var endDate = d.endDate || d.date; sheet.getRange(i + 1, 1, 1, 6).setValues([[d.date, d.name, d.category, d.method || "", d.outcome || "", endDate]]); return outputJSON({status: "success"}); } } return outputJSON({status: "error", message: "Not Found"}); }
function deleteActivity(data) { var sheet = SS.getSheetByName(SHEET_NAME_ACTIVITIES); var rows = sheet.getDataRange().getValues(); for (var i = 1; i < rows.length; i++) { var rowDate = Utilities.formatDate(new Date(rows[i][0]), Session.getScriptTimeZone(), "yyyy-MM-dd"); if (rows[i][1] === data.name && rowDate === data.date) { sheet.deleteRow(i + 1); return outputJSON({status: "success"}); } } return outputJSON({status: "error"}); }
function searchUsers(keyword) { var sheet = SS.getSheetByName(SHEET_NAME_USERS); var data = sheet.getDataRange().getValues(); var results = []; for (var i = 1; i < data.length; i++) { if (results.length >= 20) break; var row = data[i]; if (row[0].toString().indexOf(keyword) > -1 || row[1].toString().indexOf(keyword) > -1) { results.push({ id: row[0], name: row[1], role: row[2], gender: row[3], dept: row[4], disability: row[5] }); } } return outputJSON({status: "success", results: results}); }
function outputJSON(data) { return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON); }
