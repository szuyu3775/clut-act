var SS = SpreadsheetApp.getActiveSpreadsheet();
var SHEET_NAME_USERS = "Users";
var SHEET_NAME_RECORDS = "Records";
var SHEET_NAME_ACTIVITIES = "Activity_List";
var SHEET_NAME_CONFIG = "Config";

var SYSTEM_PASSWORD = "1234"; 

// === 核心工具 ===
function getHeaderMap(sheet) {
  var lastCol = sheet.getLastColumn();
  if (lastCol === 0) return {};
  var headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
  var map = {};
  headers.forEach(function(h, i) { if (h) map[h.toString().trim()] = i; });
  return map;
}

function createRowObject(map, dataObj) {
  var maxIndex = 0;
  for (var key in map) { if (map[key] > maxIndex) maxIndex = map[key]; }
  var row = new Array(maxIndex + 1).fill("");
  for (var key in dataObj) { if (map.hasOwnProperty(key)) { row[map[key]] = dataObj[key]; } }
  return row;
}

function initialSetup() {
  var sheetUsers = SS.getSheetByName(SHEET_NAME_USERS);
  if (!sheetUsers) { sheetUsers = SS.insertSheet(SHEET_NAME_USERS); sheetUsers.getRange("A1:F1").setValues([["ID", "Name", "Role", "Gender", "Dept", "Disability"]]); sheetUsers.setFrozenRows(1); }
  var sheetRecords = SS.getSheetByName(SHEET_NAME_RECORDS);
  if (!sheetRecords) { sheetRecords = SS.insertSheet(SHEET_NAME_RECORDS); var headers = ["活動名稱", "活動日期", "活動類別", "學年度", "學期", "ID", "姓名", "身分", "性別", "科系/單位", "特教類別", "寫入時間"]; sheetRecords.getRange("A1:L1").setValues([headers]); sheetRecords.setFrozenRows(1); }
  var sheetActs = SS.getSheetByName(SHEET_NAME_ACTIVITIES);
  if (!sheetActs) { sheetActs = SS.insertSheet(SHEET_NAME_ACTIVITIES); sheetActs.getRange("A1:G1").setValues([["日期(起)", "活動名稱", "活動類別", "活動方式", "具體成效", "日期(迄)", "建立時間"]]); sheetActs.setFrozenRows(1); }
  var sheetConfig = SS.getSheetByName(SHEET_NAME_CONFIG);
  if (!sheetConfig) { sheetConfig = SS.insertSheet(SHEET_NAME_CONFIG); sheetConfig.getRange("A1:B1").setValues([["活動類別選項", "特教障別選項"]]); var defaultCats = [["課業"],["職涯"],["人際"],["特教知能"],["特教宣導"],["ISP"],["ITP"],["特推會"]]; var defaultDis = [["自閉症"],["學習障礙"],["情緒行為障礙"],["腦性麻痺"],["肢體障礙"],["聽覺障礙"],["視覺障礙"],["智能障礙"],["身體病弱"],["多重障礙"],["其他障礙"]]; sheetConfig.getRange(2, 1, defaultCats.length, 1).setValues(defaultCats); sheetConfig.getRange(2, 2, defaultDis.length, 1).setValues(defaultDis); sheetConfig.setFrozenRows(1); }
}

// [Fixed] 補回此函式，解決 ReferenceError
function ensureDbStructure() {
  if (!SS.getSheetByName(SHEET_NAME_USERS) || 
      !SS.getSheetByName(SHEET_NAME_RECORDS) || 
      !SS.getSheetByName(SHEET_NAME_ACTIVITIES) || 
      !SS.getSheetByName(SHEET_NAME_CONFIG)) {
    initialSetup();
  }
}

function doGet(e) { return ContentService.createTextOutput("API V38.0 (Backend Fixed) Online"); }

function doPost(e) {
  try {
    ensureDbStructure(); // 確保資料表存在
    var data = JSON.parse(e.postData.contents);
    if (data.action === "login") { if (data.password === SYSTEM_PASSWORD) return outputJSON({status: "success"}); else return outputJSON({status: "error", message: "密碼錯誤"}); }
    if (data.action === "getSystemData") return getSystemData();
    if (data.action === "saveData") return saveData(data);
    if (data.action === "getStats") return getStats(data.userList);
    if (data.action === "importUsers") return importUsers(data.users);
    if (data.action === "searchUsers") return searchUsers(data.keyword);
    if (data.action === "getActivities") return getActivities();
    if (data.action === "batchCreateActivities") return batchCreateActivities(data.activities);
    if (data.action === "updateActivity") return updateActivity(data);
    if (data.action === "deleteActivity") return deleteActivity(data);
    if (data.action === "getReportData") return getReportData(data.filter); 
    if (data.action === "getMatrixData") return getMatrixData(data.filter, data.mergeByName);
    if (data.action === "deleteUser") return deleteUser(data.id);
    if (data.action === "getParticipants") return getParticipants(data.activityName, data.activityDate);
    if (data.action === "deleteParticipant") return deleteParticipant(data.activityName, data.activityDate, data.studentId);
    return outputJSON({status: "error", message: "Unknown Action"});
  } catch (err) { return outputJSON({status: "error", message: err.toString()}); }
}

// === 功能邏輯 ===

function getReportData(filter) {
  var sheetRec = SS.getSheetByName(SHEET_NAME_RECORDS);
  var sheetAct = SS.getSheetByName(SHEET_NAME_ACTIVITIES);
  var mapRec = getHeaderMap(sheetRec);
  var mapAct = getHeaderMap(sheetAct);
  
  var actMetaMap = {};
  if (sheetAct.getLastRow() > 1) {
    var actData = sheetAct.getRange(2, 1, sheetAct.getLastRow()-1, sheetAct.getLastColumn()).getValues();
    actData.forEach(function(row) {
      var d = Utilities.formatDate(new Date(row[mapAct["日期(起)"]]), Session.getScriptTimeZone(), "yyyy-MM-dd");
      var key = d + "_" + row[mapAct["活動名稱"]].toString().trim();
      var edRaw = row[mapAct["日期(迄)"]];
      var endDate = edRaw ? Utilities.formatDate(new Date(edRaw), Session.getScriptTimeZone(), "yyyy-MM-dd") : d;
      actMetaMap[key] = { method: row[mapAct["活動方式"]] || "", outcome: row[mapAct["具體成效"]] || "", endDate: endDate };
    });
  }

  if (sheetRec.getLastRow() <= 1) return outputJSON({status: "success", report: []});
  var data = sheetRec.getRange(2, 1, sheetRec.getLastRow() - 1, sheetRec.getLastColumn()).getValues();
  var reportMap = {};
  
  data.forEach(function(row) {
    var actDateVal = row[mapRec["活動日期"]];
    if (!actDateVal) return;
    
    var actDate = new Date(actDateVal);
    var rAcadYear = row[mapRec["學年度"]];
    var rSemester = row[mapRec["學期"]];
    
    if (filter.year && filter.year !== 'all') {
       if (filter.mode === 'calendar') {
          if (actDate.getFullYear().toString() !== filter.year.toString()) return;
       } else {
          if (rAcadYear.toString() !== filter.year.toString()) return;
          if (filter.semester && filter.semester !== 'all' && rSemester.toString() !== filter.semester.toString()) return;
       }
    }

    var actName = row[mapRec["活動名稱"]].toString().trim();
    var actDateStr = Utilities.formatDate(actDate, Session.getScriptTimeZone(), "yyyy-MM-dd");
    var key = actDateStr + "_" + actName;
    
    if (!reportMap[key]) {
      var meta = actMetaMap[key] || { method: "", outcome: "", endDate: actDateStr };
      reportMap[key] = {
        name: actName, date: actDateStr, endDate: meta.endDate, category: row[mapRec["活動類別"]],
        acadYear: rAcadYear, semester: rSemester, method: meta.method, outcome: meta.outcome,
        teacherM: 0, teacherF: 0, studentM: 0, studentF: 0, otherM: 0, otherF: 0, spedCount: 0
      };
    }
    
    var role = (row[mapRec["身分"]] || "").toString().trim();
    var gender = (row[mapRec["性別"]] || "").toString().trim();
    var disability = (row[mapRec["特教類別"]] || "").toString().trim();
    var isMale = (gender === "男");
    
    if (role === "教師") {
      if(isMale) reportMap[key].teacherM++; else reportMap[key].teacherF++;
    } else if (role === "特教生" || role === "工讀生") { // 職員已移出
      if(isMale) reportMap[key].studentM++; else reportMap[key].studentF++;
    } else {
      if(isMale) reportMap[key].otherM++; else reportMap[key].otherF++;
    }
    
    if (role === "特教生" || (disability && disability !== "無")) {
      reportMap[key].spedCount++;
    }
  });
  
  var reportList = Object.values(reportMap);
  reportList.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
  return outputJSON({status: "success", report: reportList});
}

function deleteActivity(data) {
  var sheetAct = SS.getSheetByName(SHEET_NAME_ACTIVITIES);
  var mapAct = getHeaderMap(sheetAct);
  var rowsAct = sheetAct.getDataRange().getValues();
  var isDeleted = false;
  var targetDate = data.date; 
  var targetName = data.name;
  for (var i = 1; i < rowsAct.length; i++) {
    var rowDate = Utilities.formatDate(new Date(rowsAct[i][mapAct["日期(起)"]]), Session.getScriptTimeZone(), "yyyy-MM-dd");
    if (rowsAct[i][mapAct["活動名稱"]] === targetName && rowDate === targetDate) {
      sheetAct.deleteRow(i + 1);
      isDeleted = true;
      break;
    }
  }
  if (isDeleted) {
    var sheetRec = SS.getSheetByName(SHEET_NAME_RECORDS);
    var mapRec = getHeaderMap(sheetRec);
    var rowsRec = sheetRec.getDataRange().getValues();
    for (var i = rowsRec.length - 1; i >= 1; i--) {
      var recDate = Utilities.formatDate(new Date(rowsRec[i][mapRec["活動日期"]]), Session.getScriptTimeZone(), "yyyy-MM-dd");
      var recName = rowsRec[i][mapRec["活動名稱"]];
      if (recName === targetName && recDate === targetDate) {
        sheetRec.deleteRow(i + 1);
      }
    }
    return outputJSON({status: "success"});
  }
  return outputJSON({status: "error", message: "Activity not found"});
}

function saveData(data) {
  var sheet = SS.getSheetByName(SHEET_NAME_RECORDS);
  var map = getHeaderMap(sheet);
  var lastRow = sheet.getLastRow();
  var existingSet = {}; 
  if (lastRow > 1) {
    var existingData = sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn()).getValues();
    var idxActName = map["活動名稱"];
    var idxActDate = map["活動日期"];
    var idxID = map["ID"];
    var idxName = map["姓名"];
    var inputDate = Utilities.formatDate(new Date(data.activityDate), Session.getScriptTimeZone(), "yyyy-MM-dd");
    var inputName = (data.activityName || "").toString().trim();
    for (var i = 0; i < existingData.length; i++) {
        var row = existingData[i];
        var rowDate = Utilities.formatDate(new Date(row[idxActDate]), Session.getScriptTimeZone(), "yyyy-MM-dd");
        var rowName = row[idxActName].toString().trim();
        if (rowDate === inputDate && rowName === inputName) {
            var id = row[idxID].toString().trim();
            var name = row[idxName].toString().trim();
            if (id) existingSet[id] = true; else if (name) existingSet[name] = true;
        }
    }
  }
  var timestamp = new Date();
  var actDateObj = new Date(data.activityDate);
  var year = actDateObj.getFullYear();
  var month = actDateObj.getMonth() + 1;
  var academicYear = (month >= 8) ? (year - 1911) : (year - 1912);
  var semester = (month >= 8 || month === 1) ? 1 : 2;
  var userMap = getUsersMap();
  var cleanName = (data.activityName||"").toString().trim();
  var rowsToAdd = [];
  var skippedCount = 0;
  data.userIds.forEach(function(key) {
    var u = userMap[key] || { name: key, role: "未建檔", gender:"", dept:"", disability:"" };
    var uniqueId = u.id || u.name; 
    if (existingSet[uniqueId.toString().trim()]) { skippedCount++; return; }
    rowsToAdd.push(createRowObject(map, { "活動名稱": cleanName, "活動日期": data.activityDate, "活動類別": data.activityCategory || "未分類", "學年度": academicYear, "學期": semester, "ID": u.id || key, "姓名": u.name, "身分": u.role, "性別": u.gender, "科系/單位": u.dept, "特教類別": u.disability, "寫入時間": timestamp }));
  });
  if (rowsToAdd.length > 0) { sheet.getRange(sheet.getLastRow() + 1, 1, rowsToAdd.length, rowsToAdd[0].length).setValues(rowsToAdd); }
  return outputJSON({ status: "success", count: rowsToAdd.length, skipped: skippedCount, message: "成功新增 " + rowsToAdd.length + " 筆" + (skippedCount > 0 ? "\n(已略過 " + skippedCount + " 筆重複名單)" : "") });
}

function getSystemData() { var sheetUsers = SS.getSheetByName(SHEET_NAME_USERS); var usersData = []; if (sheetUsers.getLastRow() > 1) { var map = getHeaderMap(sheetUsers); var raw = sheetUsers.getRange(2, 1, sheetUsers.getLastRow() - 1, sheetUsers.getLastColumn()).getValues(); usersData = raw.map(function(r) { return { id: (r[map["ID"]]||"").toString(), name: (r[map["Name"]]||"").toString(), role: r[map["Role"]], gender: r[map["Gender"]], dept: r[map["Dept"]], disability: r[map["Disability"]] }; }); } var sheetConfig = SS.getSheetByName(SHEET_NAME_CONFIG); var categories = [], disabilities = []; if (sheetConfig && sheetConfig.getLastRow() > 1) { var confRaw = sheetConfig.getRange(2, 1, sheetConfig.getLastRow() - 1, 2).getValues(); confRaw.forEach(function(r) { if(r[0]) categories.push(r[0].toString()); if(r[1]) disabilities.push(r[1].toString()); }); } if(categories.length===0) categories = ["課業","職涯","人際","特教知能","特教宣導","ISP","ITP","特推會"]; if(disabilities.length===0) disabilities = ["自閉症","學習障礙","情緒行為障礙","腦性麻痺","肢體障礙","聽覺障礙","視覺障礙","智能障礙","身體病弱","多重障礙","其他障礙"]; return outputJSON({ status: "success", users: usersData, config: { categories: categories, disabilities: disabilities } }); }
function getUsersMap() { var sheet = SS.getSheetByName(SHEET_NAME_USERS); var map = getHeaderMap(sheet); var data = sheet.getDataRange().getValues(); var userMap = {}; for (var i = 1; i < data.length; i++) { var row = data[i]; var u = { id: (row[map["ID"]]||"").toString(), name: (row[map["Name"]]||"").toString(), role: row[map["Role"]], gender: row[map["Gender"]], dept: row[map["Dept"]], disability: row[map["Disability"]] }; if (u.id) userMap[u.id] = u; if (u.name) userMap[u.name] = u; } return userMap; }
function getStats(inputList) { var userMap = getUsersMap(); var foundUsers = [], notFound = [], processedIds = {}; inputList.forEach(function(key) { var k = key.toString().trim(); if (!k) return; var u = userMap[k]; if (u) { var uniqueKey = u.id || u.name; if (!processedIds[uniqueKey]) { foundUsers.push(u); processedIds[uniqueKey] = true; } } else { notFound.push(k); } }); var stats = { total: foundUsers.length, roles: {} }; foundUsers.forEach(function(u) { stats.roles[u.role] = (stats.roles[u.role] || 0) + 1; }); return outputJSON({ status: "success", details: foundUsers, stats: stats, notFound: notFound }); }
function importUsers(users) { var sheet = SS.getSheetByName(SHEET_NAME_USERS); var map = getHeaderMap(sheet); var data = sheet.getDataRange().getValues(); var existingMap = {}; var idIdx = map["ID"]; for (var i = 1; i < data.length; i++) { var id = data[i][idIdx].toString(); if(id) existingMap[id] = i; } var rowsToAppend = []; var isModified = false; users.forEach(function(u) { if (u.role === "輔導人員") u.role = "職員"; if (u.disability && u.disability.toString().trim() !== "") u.role = "特教生"; var rowData = { "ID": u.id.toString(), "Name": u.name, "Role": u.role, "Gender": u.gender, "Dept": u.dept, "Disability": u.disability }; var rowArr = createRowObject(map, rowData); if (u.id && existingMap.hasOwnProperty(u.id)) { var rowIndex = existingMap[u.id]; for(var k in map) { data[rowIndex][map[k]] = rowArr[map[k]]; } isModified = true; } else { rowsToAppend.push(rowArr); } }); if (isModified && data.length > 1) sheet.getRange(2, 1, data.length - 1, data[0].length).setValues(data.slice(1)); if (rowsToAppend.length > 0) sheet.getRange(sheet.getLastRow() + 1, 1, rowsToAppend.length, rowsToAppend[0].length).setValues(rowsToAppend); return outputJSON({status: "success", count: users.length}); }
function getActivities() { var sheet = SS.getSheetByName(SHEET_NAME_ACTIVITIES); if (sheet.getLastRow() <= 1) return outputJSON({status: "success", activities: []}); var map = getHeaderMap(sheet); var lastRow = sheet.getLastRow(); var limit = 300; var startRow = Math.max(2, lastRow - limit + 1); var numRows = lastRow - startRow + 1; var data = sheet.getRange(startRow, 1, numRows, sheet.getLastColumn()).getValues(); var activities = data.map(function(row) { var d = new Date(row[map["日期(起)"]]); var dateStr = Utilities.formatDate(d, Session.getScriptTimeZone(), "yyyy-MM-dd"); var ed = row[map["日期(迄)"]] ? new Date(row[map["日期(迄)"]]) : d; var endDateStr = Utilities.formatDate(ed, Session.getScriptTimeZone(), "yyyy-MM-dd"); return { date: dateStr, endDate: endDateStr, name: row[map["活動名稱"]], category: row[map["活動類別"]], method: row[map["活動方式"]] || "", outcome: row[map["具體成效"]] || "" }; }); return outputJSON({status: "success", activities: activities.reverse()}); }
function batchCreateActivities(acts) { var sheet = SS.getSheetByName(SHEET_NAME_ACTIVITIES); var map = getHeaderMap(sheet); var timestamp = new Date(); var rows = acts.map(function(a) { var cleanName = (a.name || "").toString().trim(); var endDate = a.endDate || a.date; return createRowObject(map, { "日期(起)": a.date, "活動名稱": cleanName, "活動類別": a.category, "活動方式": a.method || "", "具體成效": a.outcome || "", "日期(迄)": endDate, "建立時間": timestamp }); }); if (rows.length > 0) sheet.getRange(sheet.getLastRow() + 1, 1, rows.length, rows[0].length).setValues(rows); return outputJSON({status: "success", count: rows.length}); }
function updateActivity(data) { var sheet = SS.getSheetByName(SHEET_NAME_ACTIVITIES); var map = getHeaderMap(sheet); var rows = sheet.getDataRange().getValues(); for (var i = 1; i < rows.length; i++) { var rowDate = Utilities.formatDate(new Date(rows[i][map["日期(起)"]]), Session.getScriptTimeZone(), "yyyy-MM-dd"); if (rows[i][map["活動名稱"]] === data.originalName && rowDate === data.originalDate) { var d = data.newData; var range = sheet.getRange(i + 1, 1, 1, sheet.getLastColumn()); var currentVals = range.getValues()[0]; currentVals[map["日期(起)"]] = d.date; currentVals[map["活動名稱"]] = d.name.trim(); currentVals[map["活動類別"]] = d.category; currentVals[map["活動方式"]] = d.method || ""; currentVals[map["具體成效"]] = d.outcome || ""; currentVals[map["日期(迄)"]] = d.endDate || d.date; range.setValues([currentVals]); return outputJSON({status: "success"}); } } return outputJSON({status: "error", message: "Not Found"}); }
function searchUsers(keyword) { var sheet = SS.getSheetByName(SHEET_NAME_USERS); var map = getHeaderMap(sheet); var data = sheet.getDataRange().getValues(); var results = []; for (var i = 1; i < data.length; i++) { if (results.length >= 20) break; var row = data[i]; var id = (row[map["ID"]]||"").toString(); var name = (row[map["Name"]]||"").toString(); if (id.indexOf(keyword) > -1 || name.indexOf(keyword) > -1) { results.push({ id: id, name: name, role: row[map["Role"]], gender: row[map["Gender"]], dept: row[map["Dept"]], disability: row[map["Disability"]] }); } } return outputJSON({status: "success", results: results}); }
function deleteUser(id) { var sheet = SS.getSheetByName(SHEET_NAME_USERS); var map = getHeaderMap(sheet); var data = sheet.getDataRange().getValues(); for (var i = 1; i < data.length; i++) { if (data[i][map["ID"]].toString() === id.toString()) { sheet.deleteRow(i + 1); return outputJSON({status: "success"}); } } return outputJSON({status: "error", message: "找不到該人員 ID"}); }
function getParticipants(actName, actDate) { var sheet = SS.getSheetByName(SHEET_NAME_RECORDS); var map = getHeaderMap(sheet); var data = sheet.getDataRange().getValues(); var list = []; var targetDate = Utilities.formatDate(new Date(actDate), Session.getScriptTimeZone(), "yyyy-MM-dd"); var targetName = actName.toString().trim(); for (var i = 1; i < data.length; i++) { var row = data[i]; var rDate = Utilities.formatDate(new Date(row[map["活動日期"]]), Session.getScriptTimeZone(), "yyyy-MM-dd"); var rName = row[map["活動名稱"]].toString().trim(); if (rDate === targetDate && rName === targetName) { list.push({ id: row[map["ID"]], name: row[map["姓名"]], dept: row[map["科系/單位"]], role: row[map["身分"]] }); } } return outputJSON({status: "success", participants: list}); }
function deleteParticipant(actName, actDate, studentId) { var sheet = SS.getSheetByName(SHEET_NAME_RECORDS); var map = getHeaderMap(sheet); var data = sheet.getDataRange().getValues(); var targetDate = Utilities.formatDate(new Date(actDate), Session.getScriptTimeZone(), "yyyy-MM-dd"); var targetName = actName.toString().trim(); var targetId = studentId.toString().trim(); for (var i = 1; i < data.length; i++) { var row = data[i]; var rDate = Utilities.formatDate(new Date(row[map["活動日期"]]), Session.getScriptTimeZone(), "yyyy-MM-dd"); var rName = row[map["活動名稱"]].toString().trim(); var rId = row[map["ID"]].toString().trim(); if (rDate === targetDate && rName === targetName && rId === targetId) { sheet.deleteRow(i + 1); return outputJSON({status: "success"}); } } return outputJSON({status: "error", message: "找不到該筆參與紀錄"}); }
function getMatrixData(filter, mergeByName) { var sheetRec = SS.getSheetByName(SHEET_NAME_RECORDS); if (sheetRec.getLastRow() <= 1) return outputJSON({status: "success", activities: [], stats: {}}); var sheetAct = SS.getSheetByName(SHEET_NAME_ACTIVITIES); var mapAct = getHeaderMap(sheetAct); var actMetaMap = {}; if (sheetAct.getLastRow() > 1) { var actData = sheetAct.getRange(2, 1, sheetAct.getLastRow()-1, sheetAct.getLastColumn()).getValues(); actData.forEach(function(row) { var d = Utilities.formatDate(new Date(row[mapAct["日期(起)"]]), Session.getScriptTimeZone(), "yyyy-MM-dd"); var key = d + "_" + row[mapAct["活動名稱"]].toString().trim(); var edRaw = row[mapAct["日期(迄)"]]; var endDate = edRaw ? Utilities.formatDate(new Date(edRaw), Session.getScriptTimeZone(), "yyyy-MM-dd") : d; actMetaMap[key] = { endDate: endDate }; }); } var mapRec = getHeaderMap(sheetRec); var allRecords = sheetRec.getRange(2, 1, sheetRec.getLastRow() - 1, sheetRec.getLastColumn()).getValues(); var activitySet = {}; var disabilityStats = {}; allRecords.forEach(function(row) { var actDateVal = row[mapRec["活動日期"]]; if (!actDateVal) return; var actDateObj = new Date(actDateVal); var rAcadYear = row[mapRec["學年度"]]; var rSemester = row[mapRec["學期"]]; if (filter.year && filter.year !== 'all') { if (filter.mode === 'calendar') { if (actDateObj.getFullYear().toString() !== filter.year.toString()) return; } else { if (rAcadYear.toString() !== filter.year.toString()) return; if (filter.semester && filter.semester !== 'all' && rSemester.toString() !== filter.semester.toString()) return; } } var actName = row[mapRec["活動名稱"]].toString().trim(); var actDate = Utilities.formatDate(actDateObj, Session.getScriptTimeZone(), "yyyy-MM-dd"); var actCat = row[mapRec["活動類別"]]; var acadYear = rAcadYear; var semester = rSemester; var metaKey = actDate + "_" + actName; var meta = actMetaMap[metaKey] || { endDate: actDate }; var endDate = meta.endDate; var key = mergeByName ? actName : (actDate + "_" + actName); if (!activitySet[key]) { activitySet[key] = { key: key, name: actName, date: actDate, endDate: endDate, category: actCat, acadYear: acadYear, semester: semester }; disabilityStats[key] = { total: 0, details: {} }; } else if (mergeByName) { if (actDate < activitySet[key].date) activitySet[key].date = actDate; if (endDate > activitySet[key].endDate) activitySet[key].endDate = endDate; } var userDisability = (row[mapRec["特教類別"]] || "").toString().trim(); disabilityStats[key].total++; if (userDisability && userDisability !== "無") { if (!disabilityStats[key].details[userDisability]) disabilityStats[key].details[userDisability] = 0; disabilityStats[key].details[userDisability]++; } }); var activities = Object.values(activitySet); if (!mergeByName) { activities.sort(function(a, b) { return new Date(a.date) - new Date(b.date); }); } else { activities.sort(function(a, b) { return a.name.localeCompare(b.name); }); } return outputJSON({ status: "success", activities: activities, stats: disabilityStats }); }
function outputJSON(data) { return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON); }
