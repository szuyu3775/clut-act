<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡´ç†ç§‘å¤§è³‡æºæ•™å®¤æ•´åˆç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Noto Sans TC', sans-serif; }
        
        /* Login */
        .login-container { max-width: 450px; margin: 80px auto; padding: 30px; background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .login-header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0; margin: -30px -30px 30px -30px; text-align: center; }

        /* Main App */
        #mainApp { display: none; }
        .main-container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .header-section { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 15px 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        .nav-pills .nav-link { color: #555; background: #fff; margin-right: 10px; border: 1px solid #ddd; font-weight: bold; padding: 8px 20px; transition: all 0.3s; }
        .nav-pills .nav-link.active { background-color: #2a5298; color: white; border-color: #2a5298; box-shadow: 0 4px 6px rgba(42, 82, 152, 0.3); }
        .table-hover tbody tr:hover { background-color: #f1f8ff; }
        .db-badge { font-size: 0.85rem; padding: 5px 12px; border-radius: 50px; font-weight: normal; letter-spacing: 0.5px; }
        .bg-purple { background-color: #6f42c1; color: white; }
        
        /* å ±è¡¨å°ˆç”¨ */
        .report-table th, .disability-table th { background-color: #f8f9fa; vertical-align: middle; text-align: center; font-size: 0.85em; white-space: nowrap; }
        .report-table td, .disability-table td { vertical-align: middle; text-align: center; font-size: 0.85em; }
        .report-header-group { background-color: #e9ecef !important; }
        .col-text { min-width: 120px; text-align: left !important; white-space: normal; }
        
        /* éšœåˆ¥çµ±è¨ˆè¡¨ (Header Sticky) */
        .disability-table th { position: sticky; top: 0; z-index: 2; background-color: #e9ecef; border: 1px solid #dee2e6; }
        .disability-total { background-color: #e2e6ea; font-weight: bold; color: #2a5298; }
        .col-disability { min-width: 60px; font-size: 0.8em; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <h5 class="mt-3 text-secondary fw-bold" id="loadingText">è™•ç†ä¸­...</h5>
</div>

<!-- 1. ç™»å…¥ä»‹é¢ -->
<div id="loginSection" class="login-container">
    <div class="login-header">
        <h3 class="fw-bold mb-0"><i class="fas fa-universal-access me-2"></i>è‡´ç†ç§‘å¤§è³‡æºæ•™å®¤</h3>
        <div class="small opacity-75">æ•´åˆç®¡ç†ç³»çµ±</div>
    </div>
    
    <form onsubmit="performLogin(event)">
        <div class="d-flex justify-content-end mb-2">
            <button class="btn btn-sm btn-link text-decoration-none text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#loginConfigBox"><i class="fas fa-cog"></i> é€£ç·šè¨­å®š</button>
        </div>
        <div class="collapse mb-3" id="loginConfigBox">
            <div class="card card-body bg-light border-0 py-2">
                <label class="form-label fw-bold text-dark small mb-1">GAS å¾Œç«¯ç¶²å€</label>
                <input type="text" id="loginApiUrl" class="form-control form-control-sm" required>
            </div>
        </div>
        <div class="mb-4">
            <label class="form-label fw-bold">å­˜å–å¯†ç¢¼</label>
            <input type="password" id="loginPassword" class="form-control form-control-lg" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
        </div>
        <div class="d-grid gap-2"><button type="submit" class="btn btn-primary btn-lg fw-bold shadow-sm">ç™»å…¥ç³»çµ±</button></div>
    </form>
    <div class="text-center mt-4 pt-3 border-top text-muted small">ç‰ˆæœ¬ï¼šv3.0 Final</div>
</div>

<!-- 2. ä¸»ç¨‹å¼ -->
<div id="mainApp">
    <div class="main-container">
        <div class="header-section">
            <div class="d-flex align-items-center gap-3">
                <h4 class="fw-bold m-0"><i class="fas fa-university me-2"></i>è‡´ç†ç§‘å¤§è³‡æºæ•™å®¤</h4>
                <div class="vr bg-white opacity-50" style="height: 1.5rem;"></div>
                <h5 class="fw-light m-0 opacity-75">æ•´åˆç®¡ç†ç³»çµ±</h5>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-link text-white text-decoration-none opacity-75" type="button" data-bs-toggle="collapse" data-bs-target="#appConfigBox"><i class="fas fa-cog"></i></button>
                <button class="btn btn-sm btn-outline-light px-3" onclick="logout()"><i class="fas fa-sign-out-alt me-1"></i>ç™»å‡º</button>
            </div>
        </div>

        <div class="collapse mb-4" id="appConfigBox">
            <div class="card card-body bg-light border-warning">
                <label class="form-label fw-bold text-dark mb-1">å¾Œç«¯ç¶²å€ (API URL)</label>
                <div class="input-group">
                    <input type="text" id="appApiUrl" class="form-control">
                    <button class="btn btn-warning fw-bold" type="button" onclick="saveUrlInApp()">æ›´æ–°é€£ç·š</button>
                </div>
            </div>
        </div>

        <ul class="nav nav-pills mb-4 nav-fill" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="pills-users-tab" data-bs-toggle="pill" data-bs-target="#pills-users">1. äººå“¡è³‡æ–™åº«</button></li>
            <li class="nav-item"><button class="nav-link" id="pills-act-mgr-tab" data-bs-toggle="pill" data-bs-target="#pills-act-mgr" onclick="loadActivityList()">2. æ´»å‹•ç®¡ç†èˆ‡åˆ—è¡¨</button></li>
            <li class="nav-item"><button class="nav-link" id="pills-activity-tab" data-bs-toggle="pill" data-bs-target="#pills-activity">3. åå–®åŒ¯å…¥èˆ‡çµ±è¨ˆ</button></li>
            <li class="nav-item"><button class="nav-link" id="pills-report-tab" data-bs-toggle="pill" data-bs-target="#pills-report" onclick="initReportFilter()">4. æˆæœå ±è¡¨</button></li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            <!-- Tab 1 -->
            <div class="tab-pane fade show active" id="pills-users">
                <div class="card mb-4 border-primary border-top border-4"><div class="card-body"><h5 class="card-title fw-bold text-primary mb-3"><i class="fas fa-search me-2"></i>è³‡æ–™åº«æŸ¥è©¢</h5><div class="input-group"><input type="text" id="userSearchInput" class="form-control" placeholder="å§“å æˆ– å­¸è™Ÿ..." onkeydown="if(event.key==='Enter') searchUser()"><button class="btn btn-primary fw-bold" onclick="searchUser()">æŸ¥è©¢</button></div><div id="searchResultArea" style="display:none;" class="mt-3"><div class="table-responsive"><table class="table table-sm table-bordered table-striped mb-0 text-center small align-middle"><thead class="table-light"><tr><th>ID</th><th>å§“å</th><th>èº«åˆ†</th><th>æ€§åˆ¥</th><th>ç§‘ç³»/å–®ä½</th><th>ç‰¹æ•™é¡åˆ¥</th></tr></thead><tbody id="searchResultBody"></tbody></table></div></div></div></div>
                <div class="card border-info border-start border-4"><div class="card-header bg-white" data-bs-toggle="collapse" data-bs-target="#importCollapse"><h6 class="m-0 fw-bold text-info"><i class="fas fa-file-import me-2"></i>æ‰¹æ¬¡åŒ¯å…¥/æ›´æ–°äººå“¡ (é»æ“Šå±•é–‹)</h6></div><div id="importCollapse" class="collapse"><div class="card-body"><div class="alert alert-light border small">è«‹å¾ Excel è¤‡è£½è²¼ä¸Šï¼š<strong>ID | å§“å | èº«åˆ† | æ€§åˆ¥ | ç§‘ç³»/å–®ä½ | ç‰¹æ•™é¡åˆ¥</strong></div><textarea id="importInput" class="form-control font-monospace" rows="4" placeholder="1101001	ç‹å°æ˜	ç‰¹æ•™ç”Ÿ	ç”·	å¤šåª’é«”ç³»	è‡ªé–‰ç—‡"></textarea><div class="text-end mt-2"><button onclick="previewImport()" class="btn btn-primary fw-bold btn-sm">è§£æä¸¦é è¦½</button></div></div></div></div>
                <div id="importPreviewArea" style="display:none;" class="card border-primary mb-3 mt-3"><div class="card-header bg-primary text-white d-flex justify-content-between"><span>é è¦½</span><span class="badge bg-white text-primary" id="previewCount">0</span></div><div class="card-body p-0"><div class="table-responsive" style="max-height: 200px;"><table class="table table-sm table-striped mb-0 text-center small"><thead><tr><th>ID</th><th>å§“å</th><th>èº«åˆ†</th><th>æ€§åˆ¥</th><th>ç§‘ç³»/å–®ä½</th><th>ç‰¹æ•™é¡åˆ¥</th></tr></thead><tbody id="previewTableBody"></tbody></table></div></div><div class="card-footer"><button onclick="submitImport()" class="btn btn-success w-100 fw-bold">ç¢ºèªå¯«å…¥</button></div></div>
            </div>

            <!-- Tab 2 -->
            <div class="tab-pane fade" id="pills-act-mgr">
                <div class="card border-warning border-start border-4 mb-4"><div class="card-header bg-white" data-bs-toggle="collapse" data-bs-target="#batchCreateCollapse"><h6 class="m-0 fw-bold text-dark"><i class="fas fa-plus-circle me-2"></i>æ‰¹æ¬¡å»ºç«‹æ´»å‹• (é»æ“Šå±•é–‹)</h6></div><div id="batchCreateCollapse" class="collapse"><div class="card-body"><div class="alert alert-light border small">è«‹å¾ Excel è¤‡è£½è²¼ä¸Šï¼š<strong>æ—¥æœŸ | æ´»å‹•åç¨± | æ´»å‹•é¡åˆ¥ | æ´»å‹•æ–¹å¼(é¸å¡«) | å…·é«”æˆæ•ˆ(é¸å¡«)</strong></div><textarea id="batchActivityInput" class="form-control font-monospace" rows="6" placeholder="2025-03-20	å­¸ç¿’ç­–ç•¥å·¥ä½œåŠ 1	èª²æ¥­	å·¥ä½œåŠ	æ»¿æ„åº¦4.8&#10;2025-05-01	å‹•å‹•æ‰‹ä¸€èµ·èŠ-DIYå¤šè‚‰	äººéš›&#10;2025-06-10	113-2å€‹åˆ¥åŒ–æ”¯æŒè¨ˆç•«æœƒè­°	ISP&#10;2025-06-20	113-2å€‹åˆ¥åŒ–è½‰éŠœæœƒè­°	ITP&#10;2025-07-01	è·æ¶¯è«®è©¢	è·æ¶¯"></textarea><div class="text-end mt-2"><button onclick="batchCreateActivities()" class="btn btn-warning fw-bold text-dark">æ‰¹æ¬¡å»ºç«‹æ´»å‹•</button></div></div></div></div>
                <div class="card shadow-sm"><div class="card-header bg-dark text-white p-2"><div class="d-flex flex-wrap align-items-center gap-2"><div class="d-flex align-items-center me-auto"><h6 class="m-0 fw-bold ps-2 me-3"><i class="fas fa-list me-2"></i>æ´»å‹•åˆ—è¡¨</h6><div class="btn-group btn-group-sm" role="group"><input type="radio" class="btn-check" name="yearMode" id="modeCalendar" autocomplete="off" checked onchange="changeYearMode('calendar')"><label class="btn btn-outline-light" for="modeCalendar">ğŸ“… ä¸€èˆ¬å¹´åº¦</label><input type="radio" class="btn-check" name="yearMode" id="modeAcademic" autocomplete="off" onchange="changeYearMode('academic')"><label class="btn btn-outline-light" for="modeAcademic">ğŸ“ å­¸å¹´åº¦</label></div></div><div class="d-flex gap-2 flex-grow-1 justify-content-end"><select id="yearFilter" class="form-select form-select-sm" style="width: auto;" onchange="this.dataset.userSelected = 'true'; filterActivities()"><option value="all">å…¨éƒ¨</option></select><input type="text" id="activitySearchInput" class="form-control form-control-sm" style="max-width: 200px;" placeholder="ğŸ” æœå°‹..." oninput="filterActivities()"><button class="btn btn-sm btn-outline-light" onclick="loadActivityList(true)"><i class="fas fa-sync-alt"></i></button></div></div></div><div class="card-body p-0"><div class="table-responsive" style="max-height: 500px;"><table class="table table-hover mb-0 align-middle small"><thead class="table-light sticky-top"><tr><th style="width: 12%">é¡åˆ¥</th><th style="width: 12%">æ—¥æœŸ</th><th style="width: 8%" class="text-secondary">å¹´åº¦/å­¸æœŸ</th><th>æ´»å‹•åç¨±</th><th class="text-end" style="width: 140px;">æ“ä½œ</th></tr></thead><tbody id="activityListBody"><tr><td colspan="5" class="text-center py-4 text-muted">è¼‰å…¥ä¸­...</td></tr></tbody></table></div></div></div>
            </div>

            <!-- Tab 3 -->
            <div class="tab-pane fade" id="pills-activity">
                <div class="alert alert-primary d-flex align-items-center mb-3"><i class="fas fa-lock me-3 fs-4"></i><div><strong>ç›®å‰æ­£åœ¨åŒ¯å…¥åå–®çš„æ´»å‹•ï¼š</strong><span id="currentActName" class="fw-bold fs-5">è«‹å…ˆè‡³ã€Œæ´»å‹•ç®¡ç†ã€é¸æ“‡æ´»å‹•</span></div></div>
                <div class="card"><div class="card-body"><div class="row g-3"><input type="hidden" id="activityName"><input type="hidden" id="activityCategory"><input type="hidden" id="activityDate"><div class="col-md-12"><div class="row text-muted small mb-2 align-items-center"><div class="col-md-4">æ—¥æœŸï¼š<span id="displayDate" class="fw-bold text-dark">-</span></div><div class="col-md-4">é¡åˆ¥ï¼š<span id="displayCategory" class="badge bg-secondary">-</span></div><div class="col-md-4 text-end"><button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('attendanceInput').value='';"><i class="fas fa-eraser me-1"></i>æ¸…ç©º</button></div></div><label class="form-label fw-bold">åƒèˆ‡åå–®</label><textarea id="attendanceInput" class="form-control" rows="10" placeholder="è«‹è²¼ä¸Šåƒèˆ‡äººå“¡åå–® (ç´”æ–‡å­—æˆ–å­¸è™Ÿ)..."></textarea></div><div class="col-12 d-flex gap-2"><button onclick="processActivity()" class="btn btn-primary w-100 py-3 fw-bold fs-5"><i class="fas fa-chart-pie me-2"></i>åˆ†æçµ±è¨ˆ</button></div></div></div></div>
                <div id="activityResultArea" style="display:none;"><div class="row g-3 mb-3"><div class="col-md-4"><div class="card bg-primary text-white h-100 text-center p-3"><h6>ç¸½äººæ•¸</h6><h1 id="actTotal" class="fw-bold display-4">0</h1></div></div><div class="col-md-8"><div class="card h-100 p-3 bg-light"><h6 class="fw-bold border-bottom pb-2">èº«åˆ†çµ±è¨ˆé è¦½</h6><div id="previewRoleStats" class="d-flex flex-wrap gap-2"></div></div></div></div><div class="card border-success border-2"><div class="card-body"><h6 class="fw-bold text-success">åå–®ç¢ºèª</h6><div id="actNames" class="text-muted small mb-3 text-truncate"></div><button onclick="saveActivity()" class="btn btn-success w-100 fw-bold py-2"><i class="fas fa-save me-2"></i>ç¢ºèªå„²å­˜</button></div></div></div>
            </div>

            <!-- Tab 4: Report -->
            <div class="tab-pane fade" id="pills-report">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                            <div class="d-flex align-items-center gap-3">
                                <h6 class="m-0 fw-bold text-nowrap"><i class="fas fa-table me-2"></i>æˆæœå ±è¡¨</h6>
                                <div class="btn-group btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="reportType" id="rptBasic" autocomplete="off" checked onchange="switchReportType('basic')">
                                    <label class="btn btn-outline-light" for="rptBasic">æ ¡å‹™åŸºæœ¬è³‡æ–™åº«</label>
                                    <input type="radio" class="btn-check" name="reportType" id="rptCareer" autocomplete="off" onchange="switchReportType('career')">
                                    <label class="btn btn-outline-light" for="rptCareer">æ´»å‹•éšœåˆ¥çµ±è¨ˆ</label>
                                </div>
                            </div>
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <select id="rptCategoryFilter" class="form-select form-select-sm text-primary fw-bold" style="display:none; width:auto;" onchange="loadDisabilityReport()">
                                    <option value="all">æ‰€æœ‰é¡åˆ¥</option>
                                    <option value="è·æ¶¯">è·æ¶¯</option>
                                    <option value="äººéš›">äººéš›</option>
                                    <option value="èª²æ¥­">èª²æ¥­</option>
                                    <option value="ç‰¹æ•™çŸ¥èƒ½">ç‰¹æ•™çŸ¥èƒ½</option>
                                    <option value="ç‰¹æ•™å®£å°">ç‰¹æ•™å®£å°</option>
                                    <option value="ISP">ISP</option>
                                    <option value="ITP">ITP</option>
                                </select>
                                <div class="btn-group btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="rptYearMode" id="rptModeCalendar" autocomplete="off" checked onchange="changeReportFilterMode('calendar')">
                                    <label class="btn btn-outline-light text-dark bg-white bg-opacity-25 border-0" for="rptModeCalendar">ğŸ“… æ—¥æ›†å¹´</label>
                                    <input type="radio" class="btn-check" name="rptYearMode" id="rptModeAcademic" autocomplete="off" onchange="changeReportFilterMode('academic')">
                                    <label class="btn btn-outline-light text-dark bg-white bg-opacity-25 border-0" for="rptModeAcademic">ğŸ“ å­¸å¹´</label>
                                </div>
                                <select id="rptYearSelect" class="form-select form-select-sm" style="width: auto;"><option value="all">å…¨éƒ¨å¹´åº¦</option></select>
                                <select id="rptSemesterSelect" class="form-select form-select-sm" style="width: auto; display:none;"><option value="all">å…¨å­¸å¹´</option><option value="1">ä¸Šå­¸æœŸ</option><option value="2">ä¸‹å­¸æœŸ</option></select>
                                <button class="btn btn-light btn-sm fw-bold" onclick="loadReportData()"><i class="fas fa-sync-alt"></i> è¼‰å…¥</button>
                                <button class="btn btn-warning btn-sm fw-bold" onclick="copyReportTable()"><i class="fas fa-copy"></i> è¤‡è£½</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 600px;">
                            <!-- Report A -->
                            <table class="table table-bordered table-hover report-table mb-0" id="reportTableBasic">
                                <thead class="sticky-top">
                                    <tr class="report-header-group"><th rowspan="2">å­¸å¹´</th><th rowspan="2">å­¸æœŸ</th><th rowspan="2">æ´»å‹•ä¸»é¡Œ</th><th rowspan="2">é¡åˆ¥</th><th rowspan="2">èµ·</th><th rowspan="2">è¿„</th><th rowspan="2" class="col-text">æ´»å‹•æ–¹å¼</th><th colspan="2">å°ˆä»»æ•™å¸«</th><th colspan="2">å­¸ç”Ÿ</th><th colspan="2">å…¶ä»–</th><th colspan="3">ç¸½è¨ˆ</th><th rowspan="2" class="bg-warning-subtle">ç‰¹æ•™ç”Ÿäººæ¬¡</th></tr>
                                    <tr class="report-header-group"><th>ç”·</th><th>å¥³</th><th>ç”·</th><th>å¥³</th><th>ç”·</th><th>å¥³</th><th>ç”·</th><th>å¥³</th><th>å°è¨ˆ</th></tr>
                                </thead>
                                <tbody id="reportTableBodyBasic"><tr><td colspan="17" class="text-center py-5 text-muted">è«‹é¸æ“‡æ¢ä»¶ä¸¦é»æ“Šè¼‰å…¥</td></tr></tbody>
                            </table>
                            <!-- Report B (Disability Stats) -->
                            <table class="table table-bordered table-hover disability-table mb-0 small" id="reportTableDisability" style="display:none;">
                                <thead id="disabilityHead"></thead><tbody id="disabilityBody"><tr><td class="text-center py-5 text-muted">è«‹é¸æ“‡æ¢ä»¶ä¸¦é»æ“Šè¼‰å…¥</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editActivityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title fw-bold">ç·¨è¼¯æ´»å‹•è³‡æ–™</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="editOriginalName"><input type="hidden" id="editOriginalDate">
                <div class="row g-3">
                    <div class="col-md-6"><label class="form-label">é–‹å§‹æ—¥æœŸ</label><input type="date" id="editDate" class="form-control"></div>
                    <div class="col-md-6"><label class="form-label">çµæŸæ—¥æœŸ</label><input type="date" id="editEndDate" class="form-control"></div>
                    <div class="col-md-6"><label class="form-label">é¡åˆ¥</label><input type="text" id="editCategory" class="form-control" list="modalCategoryOptions"><datalist id="modalCategoryOptions"><option value="ISP"><option value="ITP"><option value="èª²æ¥­"><option value="äººéš›"><option value="è·æ¶¯"></datalist></div>
                    <div class="col-12"><label class="form-label">åç¨±</label><input type="text" id="editName" class="form-control"></div>
                    <div class="col-md-6"><label class="form-label">æ–¹å¼</label><input type="text" id="editMethod" class="form-control" placeholder="ä¾‹ï¼šå·¥ä½œåŠ"></div>
                    <div class="col-md-6"><label class="form-label">æˆæ•ˆ/å‚™è¨»</label><input type="text" id="editOutcome" class="form-control" placeholder="ä¾‹ï¼šæ»¿æ„åº¦4.5"></div>
                </div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-primary" onclick="submitEditActivity()">å„²å­˜</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let API_URL = "";
    let usersToImport=[], validActivityIds=[], editModal, cachedActivities=[], currentYearMode='calendar';
    let currentReportType = 'basic'; 
    let currentReportFilterMode = 'calendar'; 

    window.onload=function(){
        editModal=new bootstrap.Modal(document.getElementById('editActivityModal'));
        const savedUrl = localStorage.getItem('gas_api_url_v1');
        if(savedUrl) {
            document.getElementById('loginApiUrl').value = savedUrl;
            document.getElementById('apiUrl').value = savedUrl;
            if(document.getElementById('appApiUrl')) document.getElementById('appApiUrl').value = savedUrl;
        }
    };

    function performLogin(e) {
        e.preventDefault();
        const url = document.getElementById('loginApiUrl').value.trim();
        const pwd = document.getElementById('loginPassword').value.trim();
        if(!url || !pwd) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
        API_URL = url;
        document.getElementById('loading').style.display = 'flex';
        fetch(url, { method: 'POST', body: JSON.stringify({ action: 'login', password: pwd }) })
        .then(res => res.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            if(data.status === 'success') {
                localStorage.setItem('gas_api_url_v1', url);
                if(document.getElementById('appApiUrl')) document.getElementById('appApiUrl').value = url;
                showMainApp();
            } else { alert("ç™»å…¥å¤±æ•—ï¼š" + (data.message || "å¯†ç¢¼éŒ¯èª¤")); }
        })
        .catch(err => { document.getElementById('loading').style.display = 'none'; alert("é€£ç·šå¤±æ•—ã€‚\n" + err); });
    }

    function showMainApp() { document.getElementById('loginSection').style.display = 'none'; document.getElementById('mainApp').style.display = 'block'; }
    function logout() { location.reload(); }
    function saveUrlInApp(){ const url=document.getElementById('appApiUrl').value.trim(); if(url){ localStorage.setItem('gas_api_url_v1',url); API_URL = url; new bootstrap.Collapse(document.getElementById('appConfigBox'),{toggle:true}).hide(); alert("ç¶²å€å·²æ›´æ–°"); } }
    function saveUrl(){ const url=document.getElementById('apiUrl').value.trim(); if(url){ localStorage.setItem('gas_api_url_v1',url); document.getElementById('loginApiUrl').value = url; API_URL = url; new bootstrap.Collapse(document.getElementById('apiConfigBox'),{toggle:true}).hide(); alert("ç¶²å€å·²å„²å­˜"); } }

    function getRoleClass(r){if(!r)return "bg-secondary";r=r.trim();if(r==="ç‰¹æ•™ç”Ÿ")return "bg-danger";if(r==="æ•™å¸«")return "bg-warning text-dark";if(r.includes("è·å“¡"))return "bg-success";if(r==="å·¥è®€ç”Ÿ")return "bg-primary";if(r==="è¼”å°äººå“¡")return "bg-warning text-dark";if(r==="å®¶é•·")return "bg-secondary";if(r==="æ ¡å¤–äººå“¡")return "bg-purple";return "bg-secondary";}
    function getCategoryClass(c){if(!c)return "bg-secondary";if(c.includes("èª²æ¥­"))return "bg-success";if(c.includes("è·æ¶¯"))return "bg-primary";if(c.includes("äººéš›"))return "bg-warning text-dark";if(c.includes("ç‰¹æ•™"))return "bg-purple";if(c.includes("ISP")||c.includes("ITP")||c.includes("æœƒè­°"))return "bg-dark";return "bg-secondary";}
    function getAcademicYear(dStr){const d=new Date(dStr); const m=d.getMonth()+1; return (m>=8)?(d.getFullYear()-1911):(d.getFullYear()-1912);}
    function getAcademicDisplay(dStr){const d=new Date(dStr); const m=d.getMonth()+1; const y=d.getFullYear(); return (m>=8)?`${y-1911}-1`:((m===1)?`${y-1912}-1`:`${y-1912}-2`);}
    function getCalendarYear(dStr){return dStr.split('-')[0];}

    function changeYearMode(mode){currentYearMode=mode;delete document.getElementById('yearFilter').dataset.userSelected;updateYearFilter(cachedActivities);filterActivities();}
    function searchUser(){const k=document.getElementById('userSearchInput').value.trim();if(!k)return alert("è«‹è¼¸å…¥");callApi({action:"searchUsers",keyword:k},res=>{const tb=document.getElementById('searchResultBody');tb.innerHTML="";document.getElementById('searchResultArea').style.display='block';if(res.results.length===0){tb.innerHTML=`<tr><td colspan="6">æŸ¥ç„¡è³‡æ–™</td></tr>`;return;}res.results.forEach(u=>{tb.innerHTML+=`<tr><td class="font-monospace fw-bold text-primary">${u.id||'-'}</td><td>${u.name}</td><td><span class="badge ${getRoleClass(u.role)} db-badge">${u.role}</span></td><td>${u.gender}</td><td>${u.dept}</td><td>${u.disability}</td></tr>`;});});}
    function previewImport(){const raw=document.getElementById('importInput').value;if(!raw.trim())return alert("ç„¡è³‡æ–™");const lines=raw.split("\n");usersToImport=[];lines.forEach(l=>{if(!l.trim())return;const c=l.split("\t").map(s=>s.trim());if(c.length>=2&&(c[0]||c[1])){let r=c[2]||"";if(r==="åŠ©ç†")r="å·¥è®€ç”Ÿ";usersToImport.push({id:c[0],name:c[1]||"æœªå‘½å",role:r,gender:c[3]||"",dept:c[4]||"",disability:c[5]||""});}});if(usersToImport.length===0)return alert("è§£æå¤±æ•—");const tb=document.getElementById('previewTableBody');tb.innerHTML="";usersToImport.forEach(u=>{tb.innerHTML+=`<tr><td>${u.id}</td><td>${u.name}</td><td><span class="badge ${getRoleClass(u.role)} db-badge">${u.role}</span></td><td>${u.gender}</td><td>${u.dept}</td><td>${u.disability}</td></tr>`;});document.getElementById('previewCount').innerText=usersToImport.length;document.getElementById('importPreviewArea').style.display='block';}
    function submitImport(){if(usersToImport.length===0)return;callApi({action:"importUsers",users:usersToImport},()=>{alert("åŒ¯å…¥æˆåŠŸ");document.getElementById('importInput').value="";document.getElementById('importPreviewArea').style.display='none';});}
    function loadActivityList(f=false){
        const tb=document.getElementById('activityListBody');
        if(f || !cachedActivities || cachedActivities.length===0){
            tb.innerHTML='<tr><td colspan="5" class="text-center py-4 text-muted">è¼‰å…¥ä¸­...</td></tr>';
            callApi({action:"getActivities"},res=>{ cachedActivities = res.activities || []; updateYearFilter(cachedActivities); filterActivities(); });
        }else{ filterActivities(); }
    }
    function updateYearFilter(acts){const yf=document.getElementById('yearFilter');const cv=yf.value;const ys=new Set();if(acts){acts.forEach(a=>ys.add(currentYearMode==='calendar'?getCalendarYear(a.date):getAcademicYear(a.date).toString()));}const sYs=Array.from(ys).sort().reverse();let ty='';const today=new Date();if(currentYearMode==='calendar')ty=today.getFullYear().toString();else{const m=today.getMonth()+1;const y=today.getFullYear();ty=((m>=8)?(y-1911):(y-1912)).toString();}yf.innerHTML='<option value="all">å…¨éƒ¨</option>';sYs.forEach(y=>yf.innerHTML+=`<option value="${y}">${y}${currentYearMode==='calendar'?'å¹´':'å­¸å¹´'}</option>`);if(yf.dataset.userSelected!=='true'&&sYs.includes(ty))yf.value=ty;else if(Array.from(yf.options).some(o=>o.value===cv))yf.value=cv;}
    function filterActivities(){const tb=document.getElementById('activityListBody');const yv=document.getElementById('yearFilter').value;const sv=document.getElementById('activitySearchInput').value.toLowerCase().trim();let f=cachedActivities.filter(a=>{let ay=(currentYearMode==='calendar')?getCalendarYear(a.date):getAcademicYear(a.date).toString();return (yv==='all'||ay===yv)&&(a.name.toLowerCase().includes(sv)||a.category.toLowerCase().includes(sv));});f.sort((a,b)=>new Date(b.date)-new Date(a.date));tb.innerHTML="";if(f.length===0){tb.innerHTML='<tr><td colspan="5" class="text-center py-4">ç„¡æ´»å‹•</td></tr>';return;}f.forEach(a=>{const r=document.createElement('tr');let dy=(currentYearMode==='calendar')?`<span class="badge bg-light text-dark border">${getCalendarYear(a.date)}</span>`:`<span class="badge bg-info text-dark">${getAcademicDisplay(a.date)}</span>`;r.innerHTML=`<td><span class="badge ${getCategoryClass(a.category)}">${a.category}</span></td><td class="text-nowrap">${a.date}</td><td>${dy}</td><td class="fw-bold text-truncate" style="max-width:200px;">${a.name}</td><td class="text-end"><button class="btn btn-primary btn-sm me-1" title="åŒ¯å…¥" onclick='selectActivity(${JSON.stringify(a)})'><i class="fas fa-user-edit"></i></button><button class="btn btn-outline-secondary btn-sm me-1" title="ç·¨è¼¯" onclick='openEditModal(${JSON.stringify(a)})'><i class="fas fa-pen"></i></button><button class="btn btn-outline-danger btn-sm" title="åˆªé™¤" onclick='deleteActivity(${JSON.stringify(a)})'><i class="fas fa-trash"></i></button></td>`;tb.appendChild(r);});}
    function batchCreateActivities(){const raw=document.getElementById('batchActivityInput').value;if(!raw.trim())return alert("è«‹è¼¸å…¥");const lines=raw.split("\n");let newActs=[];lines.forEach(l=>{const c=l.split("\t").map(s=>s.trim());if(c.length>=2)newActs.push({date:c[0],name:c[1],category:c[2]||"æœªåˆ†é¡",method:c[3]||"",outcome:c[4]||""});});if(newActs.length===0)return alert("è§£æå¤±æ•—");callApi({action:"batchCreateActivities",activities:newActs},()=>{alert("å»ºç«‹æˆåŠŸ");document.getElementById('batchActivityInput').value="";loadActivityList(true);});}
    
    function openEditModal(act){document.getElementById('editDate').value=act.date;document.getElementById('editEndDate').value=act.endDate||act.date;document.getElementById('editName').value=act.name;document.getElementById('editCategory').value=act.category;document.getElementById('editMethod').value=act.method||"";document.getElementById('editOutcome').value=act.outcome||"";document.getElementById('editOriginalName').value=act.name;document.getElementById('editOriginalDate').value=act.date;editModal.show();}
    function submitEditActivity(){const nd={date:document.getElementById('editDate').value,endDate:document.getElementById('editEndDate').value,name:document.getElementById('editName').value,category:document.getElementById('editCategory').value,method:document.getElementById('editMethod').value,outcome:document.getElementById('editOutcome').value};if(!nd.name||!nd.date)return alert("å¿…å¡«");callApi({action:"updateActivity",originalName:document.getElementById('editOriginalName').value,originalDate:document.getElementById('editOriginalDate').value,newData:nd},()=>{alert("æ›´æ–°æˆåŠŸ");editModal.hide();loadActivityList(true);});}
    function deleteActivity(act){if(!confirm("ç¢ºå®šåˆªé™¤?"))return;callApi({action:"deleteActivity",name:act.name,date:act.date},()=>{alert("å·²åˆªé™¤");loadActivityList(true);});}
    function selectActivity(act){document.getElementById('activityName').value=act.name;document.getElementById('activityDate').value=act.date;document.getElementById('activityCategory').value=act.category;document.getElementById('currentActName').innerText=act.name;document.getElementById('displayDate').innerText=act.date;document.getElementById('displayCategory').innerText=act.category;document.getElementById('displayCategory').className=`badge ${getCategoryClass(act.category)}`;document.getElementById('attendanceInput').value="";document.getElementById('activityResultArea').style.display='none';new bootstrap.Tab(document.getElementById('pills-activity-tab')).show();}
    function processActivity(){if(!document.getElementById('activityName').value)return alert("æœªé¸æ´»å‹•");const t=document.getElementById('attendanceInput').value;let l=[];const r=/[a-zA-Z0-9]+|[\u4e00-\u9fa5]+/g;let m;while((m=r.exec(t))!==null)if(m[0].length>1)l.push(m[0]);if(l.length===0)return alert("ç„¡å…§å®¹");callApi({action:"getStats",userList:l},d=>{document.getElementById('activityResultArea').style.display='block';document.getElementById('actTotal').innerText=d.stats.total;document.getElementById('actNames').innerText=d.details.map(u=>u.name).join("ã€");validActivityIds=d.details.map(u=>u.id||u.name);const p=document.getElementById('previewRoleStats');p.innerHTML="";for(let k in d.stats.roles)p.innerHTML+=`<span class="badge ${getRoleClass(k)} fs-6 me-1">${k}:${d.stats.roles[k]}</span>`;});}
    function saveActivity(){const n=document.getElementById('activityName').value;if(!n)return alert("éŒ¯èª¤");callApi({action:"saveData",activityName:n,activityCategory:document.getElementById('activityCategory').value,activityDate:document.getElementById('activityDate').value,userIds:validActivityIds},()=>{alert("å·²å„²å­˜");location.reload();});}
    function copyReportTable(){const id=currentReportType==='basic'?'reportTableBasic':'reportTableDisability'; const t=document.getElementById(id);const r=document.createRange();r.selectNode(t);window.getSelection().removeAllRanges();window.getSelection().addRange(r);document.execCommand('copy');alert("å·²è¤‡è£½");}

    function initReportFilter() {
        if (cachedActivities && cachedActivities.length > 0) { updateReportYearSelect(); loadReportData(); } else { callApi({action:"getActivities"}, res => { cachedActivities = res.activities || []; updateReportYearSelect(); loadReportData(); }); }
    }
    function switchReportType(type) {
        currentReportType = type;
        const basicTbl = document.getElementById('reportTableBasic');
        const disTbl = document.getElementById('reportTableDisability');
        const catFilter = document.getElementById('rptCategoryFilter');
        
        if (type === 'basic') {
            basicTbl.style.display = 'table';
            disTbl.style.display = 'none';
            catFilter.style.display = 'none';
        } else {
            basicTbl.style.display = 'none';
            disTbl.style.display = 'table';
            catFilter.style.display = 'inline-block';
            loadDisabilityReport(); 
        }
    }
    function changeReportFilterMode(mode) {
        currentReportFilterMode = mode;
        const semSelect = document.getElementById('rptSemesterSelect');
        semSelect.style.display = (mode === 'academic') ? 'inline-block' : 'none';
        updateReportYearSelect(); 
        if (currentReportType === 'basic') loadReportData(); else loadDisabilityReport();
    }
    function updateReportYearSelect() {
        const sel = document.getElementById('rptYearSelect');
        const years = new Set();
        if(cachedActivities) { cachedActivities.forEach(a => { if (currentReportFilterMode === 'calendar') { years.add(getCalendarYear(a.date)); } else { years.add(getAcademicYear(a.date).toString()); } }); }
        const sorted = Array.from(years).sort().reverse();
        let ty = ''; const today = new Date(); if (currentReportFilterMode === 'calendar') ty = today.getFullYear().toString(); else { const m = today.getMonth() + 1; const y = today.getFullYear(); ty = ((m >= 8) ? (y - 1911) : (y - 1912)).toString(); }
        sel.innerHTML = '<option value="all">å…¨éƒ¨å¹´åº¦</option>';
        sorted.forEach(y => { const lbl = (currentReportFilterMode === 'calendar') ? `${y} å¹´` : `${y} å­¸å¹´åº¦`; sel.innerHTML += `<option value="${y}">${lbl}</option>`; });
        if(sel.dataset.userSelected!=='true') { if(sorted.includes(ty)) sel.value = ty; else if(sorted.length > 0) sel.value = sorted[0]; } else if(Array.from(sel.options).some(o=>o.value===sel.value)) { }
    }
    
    function loadReportData() {
        if(currentReportType === 'career') { loadDisabilityReport(); return; }
        const year = document.getElementById('rptYearSelect').value;
        const semester = document.getElementById('rptSemesterSelect').value;
        const filter = { mode: currentReportFilterMode, year: year, semester: semester };
        const tbody = document.getElementById('reportTableBodyBasic');
        tbody.innerHTML = '<tr><td colspan="17" class="text-center py-5 text-muted">è¼‰å…¥ä¸­...</td></tr>';
        callApi({action:"getReportData", filter: filter}, res=>{
            if(!res.report || res.report.length===0){tbody.innerHTML='<tr><td colspan="17" class="text-center py-5">ç„¡è³‡æ–™</td></tr>';return;}
            const rows = res.report.map(r => {
                const tm=r.teacherM+r.studentM+r.otherM,tf=r.teacherF+r.studentF+r.otherF,tt=tm+tf;const st=r.semester===1?"ä¸Š":"ä¸‹";
                return `<tr><td>${r.acadYear}</td><td>${st}</td><td class="col-text fw-bold">${r.name}</td><td>${r.category}</td><td>${r.date}</td><td>${r.endDate}</td><td class="col-text">${r.method}</td><td>${r.teacherM}</td><td>${r.teacherF}</td><td>${r.studentM}</td><td>${r.studentF}</td><td>${r.otherM}</td><td>${r.otherF}</td><td class="fw-bold bg-light">${tm}</td><td class="fw-bold bg-light">${tf}</td><td class="fw-bold bg-light text-primary">${tt}</td><td class="fw-bold text-danger bg-warning-subtle">${r.spedCount}</td></tr>`;
            }).join('');
            tbody.innerHTML = rows;
        });
    }

    function loadDisabilityReport() {
        const year = document.getElementById('rptYearSelect').value;
        const semester = document.getElementById('rptSemesterSelect').value;
        const categoryFilter = document.getElementById('rptCategoryFilter').value;
        const filter = { mode: currentReportFilterMode, year: year, semester: semester };
        const thead = document.getElementById('disabilityHead');
        const tbody = document.getElementById('disabilityBody');
        tbody.innerHTML = '<tr><td class="text-center py-5 text-muted">è¼‰å…¥ä¸­...</td></tr>';
        
        callApi({action:"getMatrixData", filter: filter}, res=>{
            const activities = res.activities.filter(a => categoryFilter === 'all' || a.category.includes(categoryFilter));
            if(!activities || activities.length===0){ tbody.innerHTML='<tr><td class="text-center py-5 text-muted">ç„¡ç¬¦åˆæ¢ä»¶çš„æ´»å‹•è³‡æ–™</td></tr>'; thead.innerHTML=""; return; }
            
            const disabilities = ["è‡ªé–‰ç—‡", "å­¸ç¿’éšœç¤™", "æƒ…ç·’è¡Œç‚ºéšœç¤™", "è…¦æ€§éº»ç—º", "è‚¢é«”éšœç¤™", "è½è¦ºéšœç¤™", "è¦–è¦ºéšœç¤™", "æ™ºèƒ½éšœç¤™", "èº«é«”ç—…å¼±", "å¤šé‡éšœç¤™", "å…¶ä»–éšœç¤™"];
            
            let hRow = `<tr><th rowspan="2">æ—¥æœŸ</th><th rowspan="2">æ´»å‹•åç¨±</th><th rowspan="2">é¡åˆ¥</th><th rowspan="2" class="disability-total">åƒèˆ‡ç¸½äººæ¬¡</th>`;
            disabilities.forEach(d => { hRow += `<th class="col-disability">${d}</th>`; });
            hRow += `</tr>`;
            thead.innerHTML = hRow;

            const bHtml = activities.map(act => {
                const stat = res.stats[act.key] || { total: 0, details: {} };
                let rowHtml = `<tr><td class="text-nowrap">${act.date}</td><td class="text-start fw-bold">${act.name}</td><td><span class="badge ${getCategoryClass(act.category)}">${act.category}</span></td><td class="disability-total">${stat.total}</td>`;
                disabilities.forEach(d => {
                    const count = stat.details[d] || 0;
                    const style = count > 0 ? "fw-bold text-dark bg-warning-subtle" : "text-light";
                    rowHtml += `<td class="${style}">${count}</td>`;
                });
                rowHtml += `</tr>`;
                return rowHtml;
            }).join('');
            tbody.innerHTML = bHtml;
        });
    }

    function callApi(payload,cb){
        if(!API_URL) return alert("æœªé€£ç·šï¼Œè«‹é‡æ–°ç™»å…¥æˆ–æª¢æŸ¥è¨­å®š");
        document.getElementById('loading').style.display='flex';
        fetch(API_URL, {method:'POST', body:JSON.stringify(payload)})
        .then(r=>r.json()).then(d=>{ document.getElementById('loading').style.display='none'; cb(d); })
        .catch(e=>{ document.getElementById('loading').style.display='none'; alert("é€£ç·šéŒ¯èª¤ï¼š" + e); });
    }
</script>

</body>
</html>