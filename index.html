<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡´ç†ç§‘å¤§è³‡æºæ•™å®¤æ•´åˆç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Noto Sans TC', sans-serif; }
        
        /* Login */
        .login-container { max-width: 450px; margin: 60px auto; padding: 30px; background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .login-header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0; margin: -30px -30px 30px -30px; text-align: center; }

        /* Main App */
        #mainApp { display: none; }
        .main-container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .header-section { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 15px 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Loading */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        
        /* UI */
        .nav-pills .nav-link { color: #555; background: #fff; margin-right: 10px; border: 1px solid #ddd; font-weight: bold; padding: 8px 20px; transition: all 0.3s; }
        .nav-pills .nav-link.active { background-color: #2a5298; color: white; border-color: #2a5298; box-shadow: 0 4px 6px rgba(4px, 82, 152, 0.3); }
        .table-hover tbody tr:hover { background-color: #f1f8ff; }
        .db-badge { font-size: 0.85rem; padding: 5px 12px; border-radius: 50px; font-weight: normal; letter-spacing: 0.5px; }
        .bg-purple { background-color: #6f42c1; color: white; }
        .cell-error { background-color: #f8d7da !important; color: #dc3545; border: 2px solid #dc3545 !important; font-weight: bold; }
        .cell-error::after { content: " âš ï¸"; }

        /* Role Filter Buttons */
        .role-filter-group .btn { margin-bottom: 5px; border-radius: 20px; font-size: 0.9em; }
        .role-filter-group .btn.active { background-color: #1e3c72; color: white; border-color: #1e3c72; }

        /* Pagination */
        .pagination-container { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; }
        .page-info { font-size: 0.9rem; color: #6c757d; }

        /* Report Tables */
        .report-table th, .disability-table th { background-color: #f8f9fa; vertical-align: middle; text-align: center; font-size: 0.85em; white-space: nowrap; }
        .report-table td, .disability-table td { vertical-align: middle; text-align: center; font-size: 0.85em; }
        .disability-table th { position: sticky; top: 0; z-index: 2; background-color: #e9ecef; border: 1px solid #dee2e6; }
        .disability-total { background-color: #e2e6ea; font-weight: bold; color: #2a5298; }
        .col-disability { min-width: 40px; font-size: 0.8em; }
        
        /* Vertical Header */
        .vertical-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            white-space: nowrap;
            height: 120px;
            padding: 5px 2px;
        }
        .grand-total-row { background-color: #2a5298 !important; color: white; font-weight: bold; }

        /* Report Menu */
        .report-menu-btn {
            height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .report-menu-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .report-menu-icon { font-size: 3rem; margin-bottom: 15px; }
    </style>
</head>
<body>

<!-- å…¨å±€ Loading é®ç½© -->
<div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <h5 class="mt-3 text-secondary fw-bold" id="loadingText">è™•ç†ä¸­...</h5>
    <button class="btn btn-sm btn-outline-danger mt-4" onclick="document.getElementById('loading').style.display='none'">å¼·åˆ¶è§£é™¤é–å®š</button>
</div>

<!-- 1. Login -->
<div id="loginSection" class="login-container">
    <div class="login-header">
        <h3 class="fw-bold mb-0"><i class="fas fa-universal-access me-2"></i>è‡´ç†ç§‘å¤§è³‡æºæ•™å®¤</h3>
        <div class="small opacity-75">æ•´åˆç®¡ç†ç³»çµ±</div>
    </div>
    <form onsubmit="performLogin(event)">
        <div class="d-flex justify-content-end mb-2">
            <button class="btn btn-sm btn-link text-decoration-none text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#loginConfigBox"><i class="fas fa-cog"></i> é€£ç·šè¨­å®š</button>
        </div>
        <div class="collapse show mb-3" id="loginConfigBox">
            <div class="card card-body bg-light border-0 py-2">
                <label class="form-label fw-bold text-dark small mb-1">GAS å¾Œç«¯ç¶²å€ (API URL)</label>
                <input type="text" id="loginApiUrl" class="form-control form-control-sm" required placeholder="https://script.google.com/macros/s/..../exec">
                <div class="form-text small text-muted">è«‹ç¢ºèªç¶²å€ä»¥ /exec çµå°¾ï¼Œä¸”éƒ¨ç½²æ¬Šé™ç‚ºã€Œæ‰€æœ‰äººã€ã€‚</div>
            </div>
        </div>
        <div class="mb-4">
            <label class="form-label fw-bold">å­˜å–å¯†ç¢¼</label>
            <input type="password" id="loginPassword" class="form-control form-control-lg" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
        </div>
        <div class="d-grid gap-2"><button type="submit" id="btnLogin" class="btn btn-primary btn-lg fw-bold shadow-sm">ç™»å…¥ç³»çµ±</button></div>
    </form>
    <div class="text-center mt-4 pt-3 border-top text-muted small">
        <div>ç‰ˆæœ¬ï¼šv22.0 (Clean Code)</div>
        <div id="updateTimeDisplay">æ›´æ–°æ™‚é–“ï¼š2026-01-26 15:00</div>
    </div>
</div>

<!-- 2. Main App -->
<div id="mainApp">
    <div class="main-container">
        <!-- Header -->
        <div class="header-section">
            <div class="d-flex align-items-center gap-3">
                <h4 class="fw-bold m-0"><i class="fas fa-university me-2"></i>è‡´ç†ç§‘å¤§è³‡æºæ•™å®¤</h4>
                <div class="vr bg-white opacity-50" style="height: 1.5rem;"></div>
                <h5 class="fw-light m-0 opacity-75">æ•´åˆç®¡ç†ç³»çµ±</h5>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-link text-white text-decoration-none opacity-75" type="button" data-bs-toggle="collapse" data-bs-target="#appConfigBox"><i class="fas fa-cog"></i></button>
                <button class="btn btn-sm btn-outline-light px-3" onclick="logout()"><i class="fas fa-sign-out-alt me-1"></i>ç™»å‡º</button>
            </div>
        </div>

        <!-- å…§éƒ¨é€£ç·šè¨­å®š (éš±è—) -->
        <div class="collapse mb-4" id="appConfigBox">
            <div class="card card-body bg-light border-warning">
                <label class="form-label fw-bold text-dark mb-1">å¾Œç«¯ç¶²å€ (API URL)</label>
                <div class="input-group">
                    <input type="text" id="appApiUrl" class="form-control">
                    <button class="btn btn-warning fw-bold" type="button" onclick="saveUrlInApp()">æ›´æ–°é€£ç·š</button>
                </div>
            </div>
        </div>

        <!-- åˆ†é å°èˆª -->
        <ul class="nav nav-pills mb-4 nav-fill" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="pills-users-tab" data-bs-toggle="pill" data-bs-target="#pills-users">1. äººå“¡è³‡æ–™åº«</button></li>
            <li class="nav-item"><button class="nav-link" id="pills-act-mgr-tab" data-bs-toggle="pill" data-bs-target="#pills-act-mgr" onclick="loadActivityList()">2. æ´»å‹•ç®¡ç†èˆ‡åˆ—è¡¨</button></li>
            <li class="nav-item"><button class="nav-link" id="pills-activity-tab" data-bs-toggle="pill" data-bs-target="#pills-activity">3. åå–®åŒ¯å…¥èˆ‡çµ±è¨ˆ</button></li>
            <li class="nav-item"><button class="nav-link" id="pills-report-tab" data-bs-toggle="pill" data-bs-target="#pills-report" onclick="initReportMenu()">4. æˆæœå ±è¡¨</button></li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            
            <!-- Tab 1: Users -->
            <div class="tab-pane fade show active" id="pills-users">
                <div class="card mb-4 border-primary border-top border-4">
                    <div class="card-body">
                        <h5 class="card-title fw-bold text-primary mb-3"><i class="fas fa-users me-2"></i>äººå“¡ç®¡ç†èˆ‡æŸ¥è©¢</h5>
                        <div class="input-group mb-3">
                            <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
                            <input type="text" id="userSearchInput" class="form-control" placeholder="è¼¸å…¥å§“åæˆ–å­¸è™Ÿ... (å³æ‰“å³æ‰¾)" oninput="filterUserList()">
                            <button class="btn btn-primary fw-bold" onclick="filterUserList()">æŸ¥è©¢</button>
                        </div>
                        <div class="role-filter-group mb-3 text-center" id="roleFilterContainer"></div>

                        <div id="searchResultArea">
                            <div class="table-responsive" style="min-height: 200px;">
                                <table class="table table-sm table-bordered table-striped mb-0 text-center small align-middle table-hover">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>ID (å­¸è™Ÿ)</th>
                                            <th>å§“å</th>
                                            <th>ç‰¹æ•™é¡åˆ¥</th>
                                            <th>æ€§åˆ¥</th>
                                            <th>ç§‘ç³»/å–®ä½</th>
                                            <th>èº«åˆ†</th>
                                            <th style="width: 100px;">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="searchResultBody">
                                        <tr><td colspan="7" class="text-muted py-3">è¼‰å…¥ä¸­...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination-container">
                                <div class="page-info" id="paginationInfo">é¡¯ç¤ºç¬¬ 0-0 ç­†ï¼Œå…± 0 ç­†</div>
                                <div class="btn-group btn-group-sm" id="paginationBtns">
                                    <button class="btn btn-outline-secondary" onclick="changePage(-1)" id="btnPrevPage" disabled><i class="fas fa-chevron-left"></i></button>
                                    <button class="btn btn-outline-secondary disabled" id="pageIndicator" style="width: 80px;">1 / 1</button>
                                    <button class="btn btn-outline-secondary" onclick="changePage(1)" id="btnNextPage" disabled><i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- åŒ¯å…¥å€å¡Š -->
                <div class="card border-info border-start border-4">
                    <div class="card-header bg-white" data-bs-toggle="collapse" data-bs-target="#importCollapse" style="cursor: pointer;">
                        <h6 class="m-0 fw-bold text-info"><i class="fas fa-file-import me-2"></i>æ‰¹æ¬¡åŒ¯å…¥/æ›´æ–°äººå“¡ (é»æ“Šå±•é–‹)</h6>
                    </div>
                    <div id="importCollapse" class="collapse">
                        <div class="card-body">
                            <div class="alert alert-light border small">
                                è«‹å¾ Excel è¤‡è£½è²¼ä¸Šï¼š<strong>ID | å§“å | èº«åˆ† | æ€§åˆ¥ | ç§‘ç³» | ç‰¹æ•™é¡åˆ¥</strong><br>
                                <span class="text-danger">* ç³»çµ±è‡ªå‹•æ™ºæ…§ä¿®æ­£æ¬„ä½ã€‚è‹¥ ID é‡è¤‡ï¼Œå°‡æ›´æ–°è©²å“¡è³‡æ–™ã€‚</span>
                            </div>
                            <textarea id="importInput" class="form-control font-monospace" rows="4" placeholder="1101001	ç‹å°æ˜	ç‰¹æ•™ç”Ÿ	ç”·	å¤šåª’é«”ç³»	è‡ªé–‰ç—‡"></textarea>
                            <div class="text-end mt-2 gap-2 d-flex justify-content-end">
                                <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('importInput').value=''">æ¸…ç©º</button>
                                <button onclick="previewImport()" class="btn btn-primary fw-bold btn-sm">è§£æä¸¦é è¦½</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- åŒ¯å…¥é è¦½ -->
                <div id="importPreviewArea" style="display:none;" class="card border-primary mb-3 mt-3">
                    <div class="card-header bg-primary text-white d-flex justify-content-between">
                        <span>é è¦½èˆ‡æª¢æ ¸ (å¯ç›´æ¥é»é¸ä¿®æ­£)</span>
                        <span class="badge bg-white text-primary" id="previewCount">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="alert alert-danger m-2" id="importErrorMsg" style="display:none;">
                            <strong><i class="fas fa-exclamation-triangle"></i> è³‡æ–™æœ‰èª¤ï¼</strong> è«‹é»é¸ä¸‹æ–¹ç´…è‰²æ¬„ä½é€²è¡Œè£œå¡«ã€‚
                        </div>
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-sm table-striped mb-0 text-center small align-middle">
                                <thead class="table-light sticky-top"><tr><th>ID</th><th>å§“å</th><th>èº«åˆ†</th><th>æ€§åˆ¥ (é»æ“Šåˆ‡æ›)</th><th>ç§‘ç³»/å–®ä½</th><th>ç‰¹æ•™é¡åˆ¥</th></tr></thead>
                                <tbody id="previewTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                        <button onclick="cancelImport()" class="btn btn-secondary">å–æ¶ˆ</button>
                        <button onclick="submitImport()" id="btnSubmitImport" class="btn btn-success fw-bold">ç¢ºèªå¯«å…¥è³‡æ–™åº«</button>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Activity Manager -->
            <div class="tab-pane fade" id="pills-act-mgr">
                <div class="card border-warning border-start border-4 mb-4">
                    <div class="card-header bg-white" data-bs-toggle="collapse" data-bs-target="#batchCreateCollapse" style="cursor: pointer;">
                        <h6 class="m-0 fw-bold text-dark"><i class="fas fa-plus-circle me-2"></i>æ‰¹æ¬¡å»ºç«‹æ´»å‹• (è¡¨æ ¼æ¨¡å¼)</h6>
                    </div>
                    <div id="batchCreateCollapse" class="collapse">
                        <div class="card-body">
                            <div class="alert alert-light border small mb-2">
                                <strong><i class="fas fa-edit me-1"></i> è¼¸å…¥èªªæ˜</strong>ï¼šæ—¥æœŸè«‹è¼¸å…¥ 8 ç¢¼ (å¦‚ 20250430)ï¼Œç³»çµ±æœƒè‡ªå‹•æ ¼å¼åŒ–ã€‚
                            </div>
                            <div class="table-responsive mb-2">
                                <table class="table table-bordered table-sm align-middle">
                                    <thead class="table-light text-center">
                                        <tr>
                                            <th style="width:140px;">é–‹å§‹æ—¥æœŸ <span class="text-danger">*</span></th>
                                            <th style="width:140px;">çµæŸæ—¥æœŸ</th>
                                            <th style="width:120px;">é¡åˆ¥</th>
                                            <th>æ´»å‹•åç¨± <span class="text-danger">*</span></th>
                                            <th style="width:150px;">æˆæ•ˆ/å‚™è¨»</th>
                                            <th style="width:50px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="batchTableBody"></tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="addBatchRow()"><i class="fas fa-plus me-1"></i>æ–°å¢ä¸€åˆ—</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="clearBatchTable()"><i class="fas fa-trash-alt me-1"></i>å…¨éƒ¨æ¸…ç©º</button>
                                </div>
                                <button onclick="submitBatchActivities()" class="btn btn-warning fw-bold text-dark"><i class="fas fa-cloud-upload-alt me-1"></i>ç¢ºèªå»ºç«‹æ´»å‹•</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- æ´»å‹•åˆ—è¡¨ -->
                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white p-2">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <div class="d-flex align-items-center me-auto">
                                <h6 class="m-0 fw-bold ps-2 me-3"><i class="fas fa-list me-2"></i>æ´»å‹•åˆ—è¡¨</h6>
                                <div class="btn-group btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="yearMode" id="modeCalendar" autocomplete="off" checked onchange="changeYearMode('calendar')">
                                    <label class="btn btn-outline-light" for="modeCalendar">ğŸ“… ä¸€èˆ¬å¹´åº¦</label>
                                    <input type="radio" class="btn-check" name="yearMode" id="modeAcademic" autocomplete="off" onchange="changeYearMode('academic')">
                                    <label class="btn btn-outline-light" for="modeAcademic">ğŸ“ å­¸å¹´åº¦</label>
                                </div>
                            </div>
                            <div class="d-flex gap-2 flex-grow-1 justify-content-end">
                                <select id="yearFilter" class="form-select form-select-sm" style="width: auto;" onchange="this.dataset.userSelected = 'true'; filterActivities()">
                                    <option value="all">å…¨éƒ¨</option>
                                </select>
                                <input type="text" id="activitySearchInput" class="form-control form-control-sm" style="max-width: 200px;" placeholder="ğŸ” æœå°‹..." oninput="filterActivities()">
                                <button class="btn btn-sm btn-outline-light" onclick="loadActivityList(true)"><i class="fas fa-sync-alt"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-hover mb-0 align-middle small">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th style="width: 12%">é¡åˆ¥</th>
                                        <th style="width: 12%">æ—¥æœŸ</th>
                                        <th style="width: 8%" class="text-secondary">å¹´åº¦/å­¸æœŸ</th>
                                        <th>æ´»å‹•åç¨±</th>
                                        <th class="text-end" style="width: 140px;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="activityListBody"><tr><td colspan="5" class="text-center py-4 text-muted">è¼‰å…¥ä¸­...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Sign In -->
            <div class="tab-pane fade" id="pills-activity">
                <div class="alert alert-primary d-flex align-items-center mb-3">
                    <i class="fas fa-lock me-3 fs-4"></i>
                    <div><strong>ç›®å‰æ­£åœ¨åŒ¯å…¥åå–®çš„æ´»å‹•ï¼š</strong><span id="currentActName" class="fw-bold fs-5">è«‹å…ˆè‡³ã€Œæ´»å‹•ç®¡ç†ã€é¸æ“‡æ´»å‹•</span></div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="row g-3">
                            <input type="hidden" id="activityName">
                            <input type="hidden" id="activityCategory">
                            <input type="hidden" id="activityDate">
                            <div class="col-md-12">
                                <div class="row text-muted small mb-2 align-items-center">
                                    <div class="col-md-4">æ—¥æœŸï¼š<span id="displayDate" class="fw-bold text-dark">-</span></div>
                                    <div class="col-md-4">é¡åˆ¥ï¼š<span id="displayCategory" class="badge bg-secondary">-</span></div>
                                    <div class="col-md-4 text-end">
                                        <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('attendanceInput').value='';"><i class="fas fa-eraser me-1"></i>æ¸…ç©º</button>
                                    </div>
                                </div>
                                <label class="form-label fw-bold">åƒèˆ‡åå–®</label>
                                <textarea id="attendanceInput" class="form-control" rows="10" placeholder="è«‹è²¼ä¸Šåƒèˆ‡äººå“¡åå–® (ç´”æ–‡å­—æˆ–å­¸è™Ÿ)..."></textarea>
                            </div>
                            <div class="col-12 d-flex gap-2 justify-content-end border-top pt-3">
                                <button onclick="parseAttendance()" class="btn btn-outline-primary fw-bold" id="btnParse"><i class="fas fa-search me-1"></i>2. è§£æåå–®</button>
                                <button onclick="calculateStatsLocal()" class="btn btn-primary fw-bold" id="btnStats" style="display:none;"><i class="fas fa-chart-pie me-1"></i>3. åŸ·è¡Œçµ±è¨ˆ</button>
                            </div>
                            <div class="col-12" id="localPreviewBox" style="display:none;">
                                <div class="alert alert-info d-flex align-items-center mb-0">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <div>å·²åµæ¸¬åˆ° <strong><span id="localCount">0</span></strong> ç­†è³‡æ–™ï¼š<span id="localPreviewText" class="small text-muted"></span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="activityResultArea" style="display:none;" class="mt-4">
                    <div class="row g-3 mb-3">
                        <div class="col-md-4"><div class="card bg-primary text-white h-100 text-center p-3"><h6>ç¸½äººæ•¸</h6><h1 id="actTotal" class="fw-bold display-4">0</h1></div></div>
                        <div class="col-md-8"><div class="card h-100 p-3 bg-light"><h6 class="fw-bold border-bottom pb-2">èº«åˆ†çµ±è¨ˆé è¦½</h6><div id="previewRoleStats" class="d-flex flex-wrap gap-2"></div></div></div>
                    </div>
                </div>
                <div class="card border-success border-2">
                    <div class="card-body text-center">
                        <h5 class="text-success fw-bold mb-3">çµ±è¨ˆå®Œæˆï¼Œç¢ºèªç„¡èª¤ï¼Ÿ</h5>
                        <button onclick="saveActivity()" class="btn btn-success btn-lg w-50 fw-bold shadow"><i class="fas fa-save me-2"></i>4. ç¢ºèªä¸¦å„²å­˜</button>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Report -->
            <div class="tab-pane fade" id="pills-report">
                <!-- Menu -->
                <div id="reportMenuContainer" class="text-center py-5">
                    <h4 class="fw-bold text-secondary mb-5">è«‹é¸æ“‡å ±è¡¨é¡å‹</h4>
                    <div class="row justify-content-center g-4">
                        <div class="col-md-4">
                            <div class="card h-100 shadow-sm report-menu-btn border-success text-success bg-white" onclick="selectReport('basic')" style="cursor: pointer;">
                                <div class="card-body"><div class="report-menu-icon"><i class="fas fa-school"></i></div><div>æ ¡å‹™åŸºæœ¬è³‡æ–™åº«</div></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100 shadow-sm report-menu-btn border-primary text-primary bg-white" onclick="selectReport('career')" style="cursor: pointer;">
                                <div class="card-body"><div class="report-menu-icon"><i class="fas fa-wheelchair"></i></div><div>æ´»å‹•éšœåˆ¥çµ±è¨ˆ</div></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Content -->
                <div id="reportContentContainer" style="display: none;">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white">
                            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-sm btn-outline-light me-2" onclick="backToReportMenu()"><i class="fas fa-arrow-left"></i> è¿”å›</button>
                                    <h6 class="m-0 fw-bold text-nowrap"><i class="fas fa-table me-2"></i><span id="reportTitle">æˆæœå ±è¡¨</span></h6>
                                </div>
                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                    <div class="form-check form-switch me-3" id="mergeControl" style="display:none;">
                                        <input class="form-check-input" type="checkbox" id="mergeByNameCheck" onchange="loadDisabilityReport()">
                                        <label class="form-check-label text-white fw-bold small" for="mergeByNameCheck">ğŸ”€ åˆä½µåŒåæ´»å‹•</label>
                                    </div>
                                    <select id="rptCategoryFilter" class="form-select form-select-sm text-primary fw-bold" style="display:none; width:auto;" onchange="loadDisabilityReport()"><option value="all">æ‰€æœ‰é¡åˆ¥</option></select>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="rptYearMode" id="rptModeCalendar" autocomplete="off" checked onchange="changeReportFilterMode('calendar')"><label class="btn btn-outline-light text-dark bg-white bg-opacity-25 border-0" for="rptModeCalendar">ğŸ“… æ—¥æ›†å¹´</label>
                                        <input type="radio" class="btn-check" name="rptYearMode" id="rptModeAcademic" autocomplete="off" onchange="changeReportFilterMode('academic')"><label class="btn btn-outline-light text-dark bg-white bg-opacity-25 border-0" for="rptModeAcademic">ğŸ“ å­¸å¹´</label>
                                    </div>
                                    <select id="rptYearSelect" class="form-select form-select-sm" style="width: auto;"><option value="all">å…¨éƒ¨å¹´åº¦</option></select>
                                    <select id="rptSemesterSelect" class="form-select form-select-sm" style="width: auto; display:none;"><option value="all">å…¨å­¸å¹´</option><option value="1">ä¸Šå­¸æœŸ</option><option value="2">ä¸‹å­¸æœŸ</option></select>
                                    <button class="btn btn-light btn-sm fw-bold" onclick="loadSelectedReport()"><i class="fas fa-sync-alt"></i> è¼‰å…¥</button>
                                    <button class="btn btn-warning btn-sm fw-bold" onclick="downloadCSV()"><i class="fas fa-file-download me-1"></i> ä¸‹è¼‰CSV</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 600px;">
                                <table class="table table-bordered table-hover report-table mb-0" id="reportTableBasic" style="display:none;">
                                    <thead class="sticky-top">
                                        <tr class="report-header-group"><th>å­¸å¹´</th><th>å­¸æœŸ</th><th>æ´»å‹•ä¸»é¡Œ</th><th>é¡åˆ¥</th><th>èµ·</th><th>è¿„</th><th class="col-text">æ´»å‹•æ–¹å¼</th><th colspan="2">å°ˆä»»æ•™å¸«</th><th colspan="2">å­¸ç”Ÿ</th><th colspan="2">å…¶ä»–</th><th colspan="3">ç¸½è¨ˆ</th></tr>
                                        <tr class="report-header-group"><th>ç”·</th><th>å¥³</th><th>ç”·</th><th>å¥³</th><th>ç”·</th><th>å¥³</th><th>ç”·</th><th>å¥³</th><th>å°è¨ˆ</th></tr>
                                    </thead>
                                    <tbody id="reportTableBodyBasic"></tbody>
                                </table>
                                <table class="table table-bordered table-hover disability-table mb-0 small" id="reportTableDisability" style="display:none;">
                                    <thead id="disabilityHead" class="sticky-top"></thead>
                                    <tbody id="disabilityBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="editActivityModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title fw-bold">ç·¨è¼¯æ´»å‹•è³‡æ–™</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="editOriginalName"><input type="hidden" id="editOriginalDate"><div class="row g-3"><div class="col-md-6"><label class="form-label">é–‹å§‹æ—¥æœŸ</label><input type="date" id="editDate" class="form-control"></div><div class="col-md-6"><label class="form-label">çµæŸæ—¥æœŸ</label><input type="date" id="editEndDate" class="form-control"></div><div class="col-md-6"><label class="form-label">é¡åˆ¥</label><input type="text" id="editCategory" class="form-control" list="modalCategoryOptions"></div><div class="col-12"><label class="form-label">åç¨±</label><input type="text" id="editName" class="form-control"></div><div class="col-md-6"><label class="form-label">æ–¹å¼</label><input type="text" id="editMethod" class="form-control" placeholder="ä¾‹ï¼šå·¥ä½œåŠ"></div><div class="col-md-6"><label class="form-label">æˆæ•ˆ/å‚™è¨»</label><input type="text" id="editOutcome" class="form-control" placeholder="ä¾‹ï¼šæ»¿æ„åº¦4.5"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-primary" onclick="submitEditActivity()">å„²å­˜</button></div></div></div></div>
<div class="modal fade" id="editUserModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title fw-bold">ç·¨è¼¯äººå“¡è³‡æ–™</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label class="form-label fw-bold">ID (å­¸è™Ÿ/èº«åˆ†è­‰)</label><input type="text" id="editUserId" class="form-control" readonly disabled></div><div class="mb-3"><label class="form-label fw-bold">å§“å</label><input type="text" id="editUserName" class="form-control"></div><div class="row g-2 mb-3"><div class="col-md-6"><label class="form-label fw-bold">èº«åˆ†</label><select id="editUserRole" class="form-select"></select></div><div class="col-md-6"><label class="form-label fw-bold">æ€§åˆ¥</label><select id="editUserGender" class="form-select"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div></div><div class="mb-3"><label class="form-label fw-bold">ç§‘ç³»/å–®ä½</label><input type="text" id="editUserDept" class="form-control"></div><div class="mb-3"><label class="form-label fw-bold">ç‰¹æ•™é¡åˆ¥</label><select id="editUserDisability" class="form-select"></select></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-primary" onclick="submitEditUser()">å„²å­˜è®Šæ›´</button></div></div></div></div>
<datalist id="modalCategoryOptions"></datalist>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// --- 1. Global Helpers ---
function getRoleClass(r){if(!r)return "bg-secondary";r=r.trim();if(r==="ç‰¹æ•™ç”Ÿ")return "bg-danger";if(r==="æ•™å¸«")return "bg-warning text-dark";if(r.includes("è·å“¡"))return "bg-success";if(r==="å·¥è®€ç”Ÿ")return "bg-primary";if(r==="è¼”å°äººå“¡")return "bg-warning text-dark";if(r==="å®¶é•·")return "bg-secondary";if(r==="æ ¡å¤–äººå“¡")return "bg-purple";return "bg-secondary";}
function getCategoryClass(c){if(!c)return "bg-secondary";if(c.includes("èª²æ¥­"))return "bg-success";if(c.includes("è·æ¶¯"))return "bg-primary";if(c.includes("äººéš›"))return "bg-warning text-dark";if(c.includes("ç‰¹æ•™"))return "bg-purple";if(c.includes("ISP")||c.includes("ITP")||c.includes("æœƒè­°"))return "bg-dark";return "bg-secondary";}
function getAcademicYear(dStr){if(!dStr)return 0; const d=new Date(dStr); if(isNaN(d))return 0; const m=d.getMonth()+1; return (m>=8)?(d.getFullYear()-1911):(d.getFullYear()-1912);}
function getAcademicDisplay(dStr){if(!dStr)return ""; const d=new Date(dStr); if(isNaN(d))return ""; const m=d.getMonth()+1; const y=d.getFullYear(); return (m>=8)?`${y-1911}-1`:((m===1)?`${y-1912}-1`:`${y-1912}-2`);}
function getCalendarYear(dStr){return dStr ? dStr.split('-')[0] : "";}

// --- 2. Global Vars ---
let API_URL = "";
let usersToImport=[], validActivityIds=[], editModal, userEditModal, cachedActivities=[], currentYearMode='calendar';
let currentReportType = 'basic', currentReportFilterMode = 'calendar'; 
let tempParsedList = [];

// Data Cache
let CACHED_USERS = [];      
let CACHED_USER_MAP = {};   
let CONFIG_CATEGORIES = []; 
let CONFIG_DISABILITIES = []; 
let VALID_DISABILITIES = ["è‡ªé–‰ç—‡","å­¸ç¿’éšœç¤™","æƒ…ç·’è¡Œç‚ºéšœç¤™","è…¦æ€§éº»ç—º","è‚¢é«”éšœç¤™","è½è¦ºéšœç¤™","è¦–è¦ºéšœç¤™","æ™ºèƒ½éšœç¤™","èº«é«”ç—…å¼±","å¤šé‡éšœç¤™","å…¶ä»–éšœç¤™"]; 
const VALID_GENDERS = ["ç”·", "å¥³"];
let VALID_ROLES = ["ç‰¹æ•™ç”Ÿ", "å®¶é•·", "æ ¡å¤–äººå£«", "æ•™å¸«", "è·å“¡", "å·¥è®€ç”Ÿ"];

// Filter & Pagination
let currentUserFilter = "all"; 
let currentPage = 1;
const ITEMS_PER_PAGE = 20;
let currentFilteredResults = []; 

// --- 3. Window Onload ---
window.onload=function(){
    editModal=new bootstrap.Modal(document.getElementById('editActivityModal'));
    userEditModal=new bootstrap.Modal(document.getElementById('editUserModal'));
    addBatchRow();
    const savedUrl = localStorage.getItem('gas_api_url_v1');
    if(savedUrl) { document.getElementById('loginApiUrl').value = savedUrl; if(document.getElementById('appApiUrl')) document.getElementById('appApiUrl').value = savedUrl; }
};

// --- 4. Login & System Load ---
function performLogin(e) {
    e.preventDefault();
    const url = document.getElementById('loginApiUrl').value.trim();
    const pwd = document.getElementById('loginPassword').value.trim();
    if(!url || !pwd) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
    API_URL = url;
    const btnLogin = document.getElementById('btnLogin');
    btnLogin.disabled = true; btnLogin.innerText = "é©—è­‰ä¸­...";
    if(pwd !== "1234") { btnLogin.disabled = false; btnLogin.innerText = "ç™»å…¥ç³»çµ±"; return alert("å¯†ç¢¼éŒ¯èª¤"); }
    localStorage.setItem('gas_api_url_v1', url);
    if(document.getElementById('appApiUrl')) document.getElementById('appApiUrl').value = url;
    showMainApp();
    document.getElementById('loadingText').innerText = 'è¼‰å…¥ç³»çµ±è³‡æ–™...';
    loadSystemData();
}

function loadSystemData() {
    document.getElementById('loading').style.display='flex';
    callApi({ action: 'getSystemData' }, (res) => {
        document.getElementById('loading').style.display='none';
        if(res.status === 'success') {
            try {
                CACHED_USERS = (res.users || []).reverse(); 
                CACHED_USER_MAP = {};
                CACHED_USERS.forEach(u => { if(u.id) CACHED_USER_MAP[u.id] = u; if(u.name) CACHED_USER_MAP[u.name] = u; });
                const config = res.config || {};
                if(config.categories && config.categories.length > 0) CONFIG_CATEGORIES = config.categories;
                else CONFIG_CATEGORIES = ["èª²æ¥­","è·æ¶¯","äººéš›","ç‰¹æ•™çŸ¥èƒ½","ç‰¹æ•™å®£å°","ISP","ITP"];
                if(config.disabilities && config.disabilities.length > 0) { CONFIG_DISABILITIES = config.disabilities; VALID_DISABILITIES = config.disabilities; }
                populateDropdowns();
                preloadActivities();
                setupRoleFilters();
                filterUserList(); 
                showMainApp();
            } catch(e) { console.error("Data Error", e); }
        } else { alert("è¼‰å…¥ç³»çµ±è³‡æ–™å¤±æ•—ï¼\n" + res.message); }
    });
}

function preloadActivities() {
    if(cachedActivities.length > 0) return;
    callApi({action:"getActivities"}, res => {
        if(res.status === 'success') { cachedActivities = res.activities || []; updateYearFilter(cachedActivities); }
    }, true);
}

function populateDropdowns() {
    const dl = document.getElementById('modalCategoryOptions');
    const dlBatchList = document.querySelectorAll('.batch-cat'); 
    const options = CONFIG_CATEGORIES.map(c => `<option value="${c}">`).join('');
    dl.innerHTML = options;
    dlBatchList.forEach(e => e.innerHTML = options);
    const rf = document.getElementById('rptCategoryFilter');
    rf.innerHTML = '<option value="all">æ‰€æœ‰é¡åˆ¥</option>' + CONFIG_CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
    document.getElementById('editUserRole').innerHTML = VALID_ROLES.map(r => `<option value="${r}">${r}</option>`).join('');
    document.getElementById('editUserDisability').innerHTML = '<option value="">(ç„¡)</option>' + CONFIG_DISABILITIES.map(d => `<option value="${d}">${d}</option>`).join('');
}

function showMainApp() { document.getElementById('loginSection').style.display = 'none'; document.getElementById('mainApp').style.display = 'block'; }
function logout() { location.reload(); }
function saveUrlInApp(){ const url=document.getElementById('appApiUrl').value.trim(); if(url){ localStorage.setItem('gas_api_url_v1',url); API_URL = url; new bootstrap.Collapse(document.getElementById('appConfigBox'),{toggle:true}).hide(); alert("ç¶²å€å·²æ›´æ–°"); loadSystemData(); } }

// --- 5. User Management ---
function searchUserLocal(){ const k=document.getElementById('userSearchInput').value.trim().toLowerCase(); renderUserList(k); }
function setupRoleFilters() {
    const container = document.getElementById('roleFilterContainer');
    let html = `<button class="btn btn-outline-primary btn-sm active me-1" onclick="setRoleFilter('all', this)">å…¨éƒ¨</button>`;
    VALID_ROLES.forEach(role => { html += `<button class="btn btn-outline-primary btn-sm me-1" onclick="setRoleFilter('${role}', this)">${role}</button>`; });
    container.innerHTML = html;
}
function setRoleFilter(role, btnElement) {
    currentUserFilter = role;
    const btns = document.querySelectorAll('#roleFilterContainer .btn');
    btns.forEach(b => b.classList.remove('active'));
    btnElement.classList.add('active');
    document.getElementById('userSearchInput').value = "";
    filterUserList();
}
function filterUserList() {
    const keyword = document.getElementById('userSearchInput').value.trim().toLowerCase();
    let filtered = CACHED_USERS;
    if(currentUserFilter !== 'all') { filtered = filtered.filter(u => u.role === currentUserFilter); }
    if(keyword) { filtered = filtered.filter(u => (u.id && u.id.toLowerCase().includes(keyword)) || (u.name && (u.name || "").toLowerCase().includes(keyword)) || (u.dept && (u.dept || "").toLowerCase().includes(keyword))); }
    currentFilteredResults = filtered;
    currentPage = 1; 
    renderCurrentPage();
}
function renderCurrentPage() {
    const total = currentFilteredResults.length;
    const totalPages = Math.ceil(total / ITEMS_PER_PAGE) || 1;
    if (currentPage < 1) currentPage = 1; if (currentPage > totalPages) currentPage = totalPages;
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const displayList = currentFilteredResults.slice(start, end);
    renderUserTable(displayList, total, start + 1, Math.min(end, total));
    updatePaginationUI(totalPages);
}
function updatePaginationUI(totalPages) {
    const pageInfo = document.getElementById('pageIndicator');
    const prevBtn = document.getElementById('btnPrevPage');
    const nextBtn = document.getElementById('btnNextPage');
    if (pageInfo) pageInfo.innerText = `${currentPage} / ${totalPages}`;
    if (prevBtn) prevBtn.disabled = (currentPage === 1);
    if (nextBtn) nextBtn.disabled = (currentPage === totalPages);
}
function changePage(delta) { currentPage += delta; renderCurrentPage(); }
function renderUserTable(list, totalCount, startNum, endNum) {
    const tb = document.getElementById('searchResultBody');
    tb.innerHTML = "";
    if(list.length === 0) {
        tb.innerHTML = `<tr><td colspan="7" class="text-muted py-3">æŸ¥ç„¡ç¬¦åˆè³‡æ–™</td></tr>`;
        const info = document.getElementById('userListInfo');
        if (info) info.innerText = `å…± 0 ç­†`;
    } else {
        list.forEach(u => {
            const safeName = (u.name || "").replace(/'/g, "\\'");
            tb.innerHTML += `<tr><td class="font-monospace fw-bold text-primary">${u.id||'-'}</td><td>${u.name}</td><td>${u.disability || '-'}</td><td>${u.gender}</td><td>${u.dept}</td><td><span class="badge ${getRoleClass(u.role)} db-badge">${u.role}</span></td><td><button class="btn btn-sm btn-outline-primary me-1" onclick="openEditUserModal('${u.id}')" title="ç·¨è¼¯"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteUserLocal('${u.id}', '${safeName}')" title="åˆªé™¤"><i class="fas fa-trash-alt"></i></button></td></tr>`;
        });
        const info = document.getElementById('userListInfo');
        if (info) info.innerText = `é¡¯ç¤ºç¬¬ ${startNum}-${endNum} ç­†ï¼Œå…± ${totalCount} ç­†`;
    }
    document.getElementById('searchResultArea').style.display='block';
}
function deleteUserLocal(id, name) {
    if(!confirm(`ç¢ºå®šè¦åˆªé™¤äººå“¡ï¼š${name} (${id}) å—ï¼Ÿ\næ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) return;
    document.getElementById('loading').style.display='flex';
    callApi({action: "deleteUser", id: id}, (res) => {
        document.getElementById('loading').style.display='none';
        if(res.status === 'success') {
            CACHED_USERS = CACHED_USERS.filter(u => u.id !== id);
            delete CACHED_USER_MAP[id];
            alert("å·²åˆªé™¤");
            filterUserList();
        } else { alert("åˆªé™¤å¤±æ•—ï¼š" + res.message); }
    });
}
function openEditUserModal(userId) {
    const u = CACHED_USER_MAP[userId];
    if(!u) return alert("æ‰¾ä¸åˆ°è©²ä½¿ç”¨è€…");
    document.getElementById('editUserId').value = u.id;
    document.getElementById('editUserName').value = u.name;
    document.getElementById('editUserRole').value = u.role;
    document.getElementById('editUserGender').value = u.gender;
    document.getElementById('editUserDept').value = u.dept;
    document.getElementById('editUserDisability').value = u.disability;
    userEditModal.show();
}
function submitEditUser() {
    const btn = document.querySelector('#editUserModal .btn-primary');
    btn.disabled = true;
    const u = { id: document.getElementById('editUserId').value, name: document.getElementById('editUserName').value, role: document.getElementById('editUserRole').value, gender: document.getElementById('editUserGender').value, dept: document.getElementById('editUserDept').value, disability: document.getElementById('editUserDisability').value };
    document.getElementById('loading').style.display='flex';
    callApi({action:"importUsers", users:[u]}, () => { btn.disabled = false; userEditModal.hide(); loadSystemData(); alert("è³‡æ–™æ›´æ–°æˆåŠŸï¼"); });
}
function previewImport(){
    const raw=document.getElementById('importInput').value; if(!raw.trim())return alert("ç„¡è³‡æ–™"); const lines=raw.split("\n"); usersToImport=[]; let hasError = false;
    lines.forEach(l=>{
        if(!l.trim())return; const c=l.split("\t").map(s=>s.trim());
        if(c.length>=2 && (c[0]||c[1])){
            let u = { id: c[0] || "", name: c[1] || "", role: c[2] || "", gender: c[3] || "", dept: c[4] || "", disability: c[5] || "" };
            if(u.role==="åŠ©ç†") u.role="å·¥è®€ç”Ÿ"; if(u.role==="è¼”å°äººå“¡") u.role="è·å“¡";
            if (VALID_DISABILITIES.includes(u.role)) { u.disability = u.role; u.role = ""; }
            if(u.disability && u.disability.trim() !== "") { u.role = "ç‰¹æ•™ç”Ÿ"; }
            u.errors = {};
            if(u.id && !/^[a-zA-Z0-9]+$/.test(u.id)) { u.errors.id = true; hasError = true; }
            if(!u.name || u.name.length < 2 || u.name.length > 4) { u.errors.name = true; hasError = true; }
            if(u.gender && !VALID_GENDERS.includes(u.gender)) { u.errors.gender = true; hasError = true; } else if (!u.gender) { u.errors.gender = true; hasError = true; }
            if(!VALID_ROLES.includes(u.role)) { u.errors.role = true; hasError = true; }
            if(u.role === "ç‰¹æ•™ç”Ÿ") { if(!VALID_DISABILITIES.includes(u.disability)) { u.errors.disability = true; hasError = true; } }
            else { if(u.disability && !VALID_DISABILITIES.includes(u.disability)) { u.errors.disability = true; hasError = true; } }
            usersToImport.push(u);
        }
    });
    if(usersToImport.length===0) return alert("è§£æå¤±æ•—");
    renderImportTable(hasError);
    document.getElementById('importPreviewArea').style.display='block'; document.getElementById('importCollapse').classList.remove('show');
}
function renderImportTable(initialErrorState) {
    const tb = document.getElementById('previewTableBody'); tb.innerHTML = ""; let stillHasError = false;
    usersToImport.forEach((u, idx) => {
        const idCls = u.errors.id ? 'cell-error' : ''; const nameCls = u.errors.name ? 'cell-error' : ''; const roleCls = u.errors.role ? 'cell-error' : ''; const disCls = u.errors.disability ? 'cell-error' : ''; const genderErr = u.errors.gender ? 'border border-danger rounded p-1' : 'p-1';
        if(u.errors.id || u.errors.name || u.errors.disability || u.errors.gender || u.errors.role) stillHasError = true;
        const isMale = u.gender === 'ç”·'; const isFemale = u.gender === 'å¥³';
        let genderHtml = `<div class="d-flex justify-content-center gap-1 ${genderErr}"><button type="button" class="btn btn-sm ${isMale ? 'btn-primary' : 'btn-outline-secondary'} flex-fill" style="min-width:30px" onclick="setImportGender(${idx}, 'ç”·')">ç”·</button><button type="button" class="btn btn-sm ${isFemale ? 'btn-danger' : 'btn-outline-secondary'} flex-fill" style="min-width:30px" onclick="setImportGender(${idx}, 'å¥³')">å¥³</button></div>`;
        tb.innerHTML += `<tr><td class="${idCls}">${u.id}</td><td class="${nameCls}">${u.name}</td><td class="${roleCls}"><span class="badge ${getRoleClass(u.role)} db-badge">${u.role||"ç¼º"}</span></td><td>${genderHtml}</td><td>${u.dept}</td><td class="${disCls}">${u.disability}</td></tr>`;
    });
    document.getElementById('previewCount').innerText = usersToImport.length; updateSubmitButton(stillHasError);
}
function setImportGender(idx, val) { usersToImport[idx].gender = val; if (VALID_GENDERS.includes(val)) usersToImport[idx].errors.gender = false; else usersToImport[idx].errors.gender = true; renderImportTable(); }
function updateSubmitButton(hasError) { const btn = document.getElementById('btnSubmitImport'); const msg = document.getElementById('importErrorMsg'); if(hasError) { btn.disabled = true; btn.innerText = "è«‹ä¿®æ­£éŒ¯èª¤æ¬„ä½"; btn.classList.replace('btn-success', 'btn-secondary'); msg.style.display = 'block'; } else { btn.disabled = false; btn.innerText = "ç¢ºèªå¯«å…¥è³‡æ–™åº«"; btn.classList.replace('btn-secondary', 'btn-success'); msg.style.display = 'none'; } }
function cancelImport() { document.getElementById('importPreviewArea').style.display='none'; document.getElementById('importCollapse').classList.add('show'); usersToImport = []; }
function submitImport(){if(usersToImport.length===0)return; document.getElementById('loading').style.display='flex'; callApi({action:"importUsers",users:usersToImport},()=>{ document.getElementById('loading').style.display='none'; alert("åŒ¯å…¥æˆåŠŸ");document.getElementById('importInput').value="";document.getElementById('importPreviewArea').style.display='none'; document.getElementById('importCollapse').classList.add('show'); loadSystemData(); });}

// --- 6. Report Logic ---
function initReportMenu() {
    document.getElementById('reportMenuContainer').style.display = 'block';
    document.getElementById('reportContentContainer').style.display = 'none';
    if (cachedActivities && cachedActivities.length > 0) { updateReportYearSelect(); } 
    else { callApi({action:"getActivities"}, res => { cachedActivities = res.activities || []; updateReportYearSelect(); }); }
}
function selectReport(type) {
    currentReportType = type;
    document.getElementById('reportMenuContainer').style.display = 'none';
    document.getElementById('reportContentContainer').style.display = 'block';
    const basicTbl = document.getElementById('reportTableBasic');
    const disTbl = document.getElementById('reportTableDisability');
    const catFilter = document.getElementById('rptCategoryFilter');
    const mergeControl = document.getElementById('mergeControl');
    // Reset Views
    basicTbl.style.display = 'none';
    disTbl.style.display = 'none';
    if (type === 'basic') {
        document.getElementById('reportTitle').innerText = 'æ ¡å‹™åŸºæœ¬è³‡æ–™åº«';
        basicTbl.style.display = 'table';
        catFilter.style.display = 'none';
        mergeControl.style.display = 'none';
        loadReportData();
    } else {
        document.getElementById('reportTitle').innerText = 'æ´»å‹•éšœåˆ¥çµ±è¨ˆ';
        disTbl.style.display = 'table';
        catFilter.style.display = 'inline-block';
        mergeControl.style.display = 'inline-block';
        loadDisabilityReport();
    }
}
function backToReportMenu() {
    document.getElementById('reportContentContainer').style.display = 'none';
    document.getElementById('reportMenuContainer').style.display = 'block';
    document.getElementById('reportTableBodyBasic').innerHTML = '';
    document.getElementById('disabilityHead').innerHTML = '';
    document.getElementById('disabilityBody').innerHTML = '';
}
function loadSelectedReport() { if (currentReportType === 'basic') loadReportData(); else loadDisabilityReport(); }
function changeReportFilterMode(mode) {
    currentReportFilterMode = mode;
    const semSelect = document.getElementById('rptSemesterSelect');
    semSelect.style.display = (mode === 'academic') ? 'inline-block' : 'none';
    updateReportYearSelect(); 
    loadSelectedReport();
}
function updateReportYearSelect() {
    const sel = document.getElementById('rptYearSelect');
    const years = new Set();
    if(cachedActivities) { cachedActivities.forEach(a => { if (currentReportFilterMode === 'calendar') { years.add(getCalendarYear(a.date)); } else { years.add(getAcademicYear(a.date).toString()); } }); }
    const sorted = Array.from(years).sort().reverse();
    let ty = ''; const today = new Date(); if (currentReportFilterMode === 'calendar') ty = today.getFullYear().toString(); else { const m = today.getMonth() + 1; const y = today.getFullYear(); ty = ((m >= 8) ? (y - 1911) : (y - 1912)).toString(); }
    sel.innerHTML = '<option value="all">å…¨éƒ¨å¹´åº¦</option>';
    sorted.forEach(y => { const lbl = (currentReportFilterMode === 'calendar') ? `${y} å¹´` : `${y} å­¸å¹´åº¦`; sel.innerHTML += `<option value="${y}">${lbl}</option>`; });
    if(sel.dataset.userSelected!=='true') { if(sorted.includes(ty)) sel.value = ty; else if(sorted.length > 0) sel.value = sorted[0]; }
}
function loadReportData() {
    const year = document.getElementById('rptYearSelect').value;
    const semester = document.getElementById('rptSemesterSelect').value;
    const filter = { mode: currentReportFilterMode, year: year, semester: semester };
    const tbody = document.getElementById('reportTableBodyBasic');
    tbody.innerHTML = '<tr><td colspan="17" class="text-center py-5 text-muted">è¼‰å…¥ä¸­...</td></tr>';
    callApi({action:"getReportData", filter: filter}, res=>{
        if(!res.report || res.report.length===0){tbody.innerHTML='<tr><td colspan="17" class="text-center py-5">ç„¡è³‡æ–™</td></tr>';return;}
        const rows = res.report.map(r => {
            const tm=r.teacherM+r.studentM+r.otherM,tf=r.teacherF+r.studentF+r.otherF,tt=tm+tf;const st=r.semester===1?"ä¸Š":"ä¸‹";
            return `<tr><td>${r.acadYear}</td><td>${st}</td><td class="col-text fw-bold">${r.name}</td><td>${r.category}</td><td>${r.date}</td><td>${r.endDate}</td><td class="col-text">${r.method}</td><td>${r.teacherM}</td><td>${r.teacherF}</td><td>${r.studentM}</td><td>${r.studentF}</td><td>${r.otherM}</td><td>${r.otherF}</td><td class="fw-bold bg-light">${tm}</td><td class="fw-bold bg-light">${tf}</td><td class="fw-bold bg-light text-primary">${tt}</td></tr>`;
        }).join('');
        tbody.innerHTML = rows;
    });
}
function loadDisabilityReport() {
    const year = document.getElementById('rptYearSelect').value;
    const semester = document.getElementById('rptSemesterSelect').value;
    const categoryFilter = document.getElementById('rptCategoryFilter').value;
    const merge = document.getElementById('mergeByNameCheck').checked; 
    const filter = { mode: currentReportFilterMode, year: year, semester: semester };
    const thead = document.getElementById('disabilityHead');
    const tbody = document.getElementById('disabilityBody');
    tbody.innerHTML = '<tr><td class="text-center py-5 text-muted">è¼‰å…¥ä¸­...</td></tr>';
    
    callApi({action:"getMatrixData", filter: filter, mergeByName: merge}, res=>{
        const activities = res.activities.filter(a => categoryFilter === 'all' || a.category.includes(categoryFilter));
        if(!activities || activities.length===0){ tbody.innerHTML='<tr><td class="text-center py-5 text-muted">ç„¡ç¬¦åˆæ¢ä»¶çš„æ´»å‹•è³‡æ–™</td></tr>'; thead.innerHTML=""; return; }
        
        const disabilities = ["è‡ªé–‰ç—‡", "èº«é«”ç—…å¼±", "è‚¢é«”éšœç¤™", "æƒ…ç·’è¡Œç‚ºéšœç¤™", "æ™ºèƒ½éšœç¤™", "è¦–è¦ºéšœç¤™", "è…¦æ€§éº»ç—º", "å­¸ç¿’éšœç¤™", "è½è¦ºéšœç¤™", "å¤šé‡éšœç¤™"];
        
        let hRow = `<tr><th class="align-middle">å­¸å¹´</th><th class="align-middle">å­¸æœŸ</th><th class="align-middle">æ´»å‹•ä¸»é¡Œ</th><th class="align-middle">é¡åˆ¥</th><th class="align-middle">èµ·</th><th class="align-middle">è¿„</th>`;
        disabilities.forEach(d => { hRow += `<th class="vertical-header align-bottom"><div>${d}</div></th>`; });
        hRow += `<th class="align-middle disability-total">ç¸½è¨ˆ</th></tr>`;
        thead.innerHTML = hRow;

        let colTotals = {}; disabilities.forEach(d => colTotals[d] = 0);
        let grandTotal = 0;

        let bHtml = activities.map(act => {
            const stat = (res.stats && res.stats[act.key]) ? res.stats[act.key] : { total: 0, details: {} };
            let rowSum = 0; let cellsHtml = "";
            disabilities.forEach(d => {
                const count = stat.details[d] || 0;
                rowSum += count; colTotals[d] += count;
                const style = count > 0 ? "fw-bold text-dark bg-warning-subtle" : "text-light";
                cellsHtml += `<td class="${style}">${count}</td>`;
            });
            grandTotal += rowSum;
            const semesterText = act.semester == 1 ? "ä¸Š" : "ä¸‹";
            return `<tr><td>${act.acadYear || "-"}</td><td>${semesterText}</td><td class="text-start fw-bold text-wrap" style="max-width:200px;">${act.name}</td><td><span class="badge ${getCategoryClass(act.category)}">${act.category}</span></td><td class="text-nowrap small">${act.date}</td><td class="text-nowrap small">${act.endDate}</td>${cellsHtml}<td class="disability-total">${rowSum}</td></tr>`;
        }).join('');
        
        let footerHtml = `<tr class="grand-total-row"><td colspan="6" class="text-end pe-3">æœ¬é ç¸½è¨ˆ</td>`;
        disabilities.forEach(d => { footerHtml += `<td>${colTotals[d]}</td>`; });
        footerHtml += `<td>${grandTotal}</td></tr>`;
        tbody.innerHTML = bHtml + footerHtml;
    });
}

// --- 7. Activity Functions ---
function loadActivityList(f=false){const tb=document.getElementById('activityListBody');if(f || !cachedActivities || cachedActivities.length===0){tb.innerHTML='<tr><td colspan="5" class="text-center py-4 text-muted">è¼‰å…¥ä¸­...</td></tr>';callApi({action:"getActivities"},res=>{ cachedActivities = res.activities || []; updateYearFilter(cachedActivities); filterActivities(); });}else{ filterActivities(); }}
function filterActivities(){const tb=document.getElementById('activityListBody');const yv=document.getElementById('yearFilter').value;const sv=document.getElementById('activitySearchInput').value.toLowerCase().trim();let f=cachedActivities.filter(a=>{let ay=(currentYearMode==='calendar')?getCalendarYear(a.date):getAcademicYear(a.date).toString();return (yv==='all'||ay===yv)&&((a.name||"").toLowerCase().includes(sv)||(a.category||"").toLowerCase().includes(sv));});f.sort((a,b)=>new Date(b.date)-new Date(a.date));tb.innerHTML="";if(f.length===0){tb.innerHTML='<tr><td colspan="5" class="text-center py-4">ç„¡æ´»å‹•</td></tr>';return;}f.forEach(a=>{const r=document.createElement('tr');let dy=(currentYearMode==='calendar')?`<span class="badge bg-light text-dark border">${getCalendarYear(a.date)}</span>`:`<span class="badge bg-info text-dark">${getAcademicDisplay(a.date)}</span>`;r.innerHTML=`<td><span class="badge ${getCategoryClass(a.category)}">${a.category}</span></td><td class="text-nowrap">${a.date}</td><td>${dy}</td><td class="fw-bold text-truncate" style="max-width:200px;">${a.name}</td><td class="text-end"><button class="btn btn-primary btn-sm me-1" title="åŒ¯å…¥" onclick='selectActivity(${JSON.stringify(a)})'><i class="fas fa-user-edit"></i></button><button class="btn btn-outline-secondary btn-sm me-1" title="ç·¨è¼¯" onclick='openEditModal(${JSON.stringify(a)})'><i class="fas fa-pen"></i></button><button class="btn btn-outline-danger btn-sm" title="åˆªé™¤" onclick='deleteActivity(${JSON.stringify(a)})'><i class="fas fa-trash"></i></button></td>`;tb.appendChild(r);});}
function addBatchRow() {const tbody = document.getElementById('batchTableBody');const tr = document.createElement('tr');tr.innerHTML = `<td><input type="text" class="form-control form-control-sm batch-start" placeholder="YYYYMMDD"></td><td><input type="text" class="form-control form-control-sm batch-end" placeholder="YYYYMMDD"></td><td><input type="text" class="form-control form-control-sm batch-cat" list="modalCategoryOptions"></td><td><input type="text" class="form-control form-control-sm batch-name"></td><td><input type="text" class="form-control form-control-sm batch-outcome"></td><td class="text-center"><button class="btn btn-link text-danger p-0" onclick="this.closest('tr').remove()"><i class="fas fa-times"></i></button></td>`;tbody.appendChild(tr);}
function clearBatchTable() { document.getElementById('batchTableBody').innerHTML = ""; addBatchRow(); }
function formatDateString(str) { if(!str) return ""; str = str.trim(); if(/^\d{8}$/.test(str)) { return `${str.substring(0,4)}-${str.substring(4,6)}-${str.substring(6,8)}`; } return str; }
function submitBatchActivities() {
    const rows = document.querySelectorAll('#batchTableBody tr');
    let newActs = [];
    rows.forEach(row => {
        const startRaw = row.querySelector('.batch-start').value;
        const endRaw = row.querySelector('.batch-end').value;
        const start = formatDateString(startRaw);
        const end = formatDateString(endRaw);
        const cat = row.querySelector('.batch-cat').value;
        const name = row.querySelector('.batch-name').value.trim();
        const outcome = row.querySelector('.batch-outcome').value.trim();
        if(start && name) { newActs.push({ date: start, endDate: end || start, category: cat || "æœªåˆ†é¡", name: name, method: "", outcome: outcome }); }
    });
    if(newActs.length === 0) return alert("è«‹è‡³å°‘å¡«å¯«ä¸€åˆ—å®Œæ•´çš„æ´»å‹•è³‡æ–™ (æ—¥æœŸèˆ‡åç¨±å¿…å¡«)");
    document.getElementById('loading').style.display='flex';
    callApi({action: "batchCreateActivities", activities: newActs}, (res) => { document.getElementById('loading').style.display='none'; alert(`æˆåŠŸå»ºç«‹ ${res.count} ç­†æ´»å‹•ï¼`); clearBatchTable(); loadActivityList(true); });
}
function openEditModal(act){document.getElementById('editDate').value=act.date;document.getElementById('editEndDate').value=act.endDate||act.date;document.getElementById('editName').value=act.name;document.getElementById('editCategory').value=act.category;document.getElementById('editMethod').value=act.method||"";document.getElementById('editOutcome').value=act.outcome||"";document.getElementById('editOriginalName').value=act.name;document.getElementById('editOriginalDate').value=act.date;editModal.show();}
function submitEditActivity(){const nd={date:document.getElementById('editDate').value,endDate:document.getElementById('editEndDate').value,name:document.getElementById('editName').value,category:document.getElementById('editCategory').value,method:document.getElementById('editMethod').value,outcome:document.getElementById('editOutcome').value};if(!nd.name||!nd.date)return alert("å¿…å¡«");callApi({action:"updateActivity",originalName:document.getElementById('editOriginalName').value,originalDate:document.getElementById('editOriginalDate').value,newData:nd},()=>{alert("æ›´æ–°æˆåŠŸ");editModal.hide();loadActivityList(true);});}
function deleteActivity(act){if(!confirm("ç¢ºå®šåˆªé™¤?"))return;callApi({action:"deleteActivity",name:act.name,date:act.date},()=>{alert("å·²åˆªé™¤");loadActivityList(true);});}
function selectActivity(act){document.getElementById('activityName').value=act.name;document.getElementById('activityDate').value=act.date;document.getElementById('activityCategory').value=act.category;document.getElementById('currentActName').innerText=act.name;document.getElementById('displayDate').innerText=act.date;document.getElementById('displayCategory').innerText=act.category;document.getElementById('displayCategory').className=`badge ${getCategoryClass(act.category)}`;document.getElementById('attendanceInput').value="";document.getElementById('activityResultArea').style.display='none';document.getElementById('localPreviewBox').style.display='none';document.getElementById('btnStats').style.display='none';new bootstrap.Tab(document.getElementById('pills-activity-tab')).show();}
function parseAttendance() {const text = document.getElementById('attendanceInput').value; tempParsedList = []; const regex = /[a-zA-Z0-9]+|[\u4e00-\u9fa5]+/g; let match; while ((match = regex.exec(text)) !== null) { if (match[0].length > 1) tempParsedList.push(match[0]); } if(tempParsedList.length === 0) return alert("ç„¡æ³•è¾¨è­˜æœ‰æ•ˆåå–®ï¼Œè«‹ç¢ºèªè¼¸å…¥å…§å®¹ã€‚"); document.getElementById('localCount').innerText = tempParsedList.length; document.getElementById('localPreviewText').innerText = tempParsedList.slice(0, 5).join(", ") + (tempParsedList.length > 5 ? "..." : ""); document.getElementById('localPreviewBox').style.display = 'block'; document.getElementById('btnStats').style.display = 'inline-block';}
function calculateStatsLocal() {let details = [], stats = { total: 0, roles: {} }; let processedIds = {}; tempParsedList.forEach(key => { let u = CACHED_USER_MAP[key]; if (u) { let uid = u.id || u.name; if (!processedIds[uid]) { details.push(u); processedIds[uid] = true; stats.roles[u.role] = (stats.roles[u.role] || 0) + 1; } } }); stats.total = details.length; validActivityIds = details.map(u => u.id || u.name); document.getElementById('activityResultArea').style.display='block'; document.getElementById('actTotal').innerText = stats.total; const p=document.getElementById('previewRoleStats'); p.innerHTML=""; for(let k in stats.roles) p.innerHTML+=`<span class="badge ${getRoleClass(k)} fs-6 me-1">${k}:${stats.roles[k]}</span>`;}
function saveActivity(){const n=document.getElementById('activityName').value;if(!n)return alert("éŒ¯èª¤"); callApi({action:"saveData",activityName:n,activityCategory:document.getElementById('activityCategory').value,activityDate:document.getElementById('activityDate').value,userIds:validActivityIds},()=>{alert("å·²å„²å­˜");location.reload();});}

function callApi(payload,cb,silent=false){
    if(!API_URL) return alert("æœªé€£ç·šï¼Œè«‹é‡æ–°ç™»å…¥æˆ–æª¢æŸ¥è¨­å®š");
    if(!silent) document.getElementById('loading').style.display='flex';
    fetch(API_URL, {method:'POST', body:JSON.stringify(payload)})
    .then(r=>r.json()).then(d=>{ 
        if(!silent) document.getElementById('loading').style.display='none'; 
        cb(d); 
    })
    .catch(e=>{ 
        if(!silent) document.getElementById('loading').style.display='none'; 
        if(!silent) alert("é€£ç·šéŒ¯èª¤ï¼š" + e); 
    });
}
</script>

</body>
</html>
